name: Build Plugins

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Makefile'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Makefile'
  workflow_dispatch:  # Allow manual triggering
  release:
    types: [created]

jobs:
  # ===========================================================================
  # Linux x64 Build
  # ===========================================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make libgomp1
          # Note: Linux uses dynamic libgomp (static linking not possible for shared libs)

      - name: Build Linux plugin
        run: make linux

      - name: Verify build
        run: |
          ls -la build/
          file build/ctools_linux.plugin

          echo ""
          echo "=== Dynamic dependencies ==="
          ldd build/ctools_linux.plugin

          echo ""
          echo "=== OpenMP status ==="
          if ldd build/ctools_linux.plugin | grep -q "libgomp"; then
            echo "✓ OpenMP enabled (libgomp dynamically linked)"
            echo "  Note: Linux requires libgomp.so at runtime (installed via libgomp1 package)"
          else
            echo "OpenMP not linked"
          fi

      - name: Upload Linux plugin
        uses: actions/upload-artifact@v4
        with:
          name: ctools_linux
          path: build/ctools_linux.plugin
          if-no-files-found: error

  # ===========================================================================
  # macOS Apple Silicon (ARM64) Build
  # ===========================================================================
  build-macos-arm:
    runs-on: macos-14  # M1 runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenMP (libomp)
        run: |
          brew install libomp
          echo "LIBOMP_PREFIX=$(brew --prefix libomp)" >> $GITHUB_ENV

      - name: Build macOS ARM plugin
        run: make macos-arm

      - name: Verify build
        run: |
          ls -la build/
          file build/ctools_mac_arm.plugin

          echo ""
          echo "=== Checking OpenMP linking ==="
          if otool -L build/ctools_mac_arm.plugin | grep -q "libomp"; then
            echo "⚠ libomp is dynamically linked"
          else
            echo "✓ libomp is NOT in dynamic dependencies (statically linked)"
          fi

          echo ""
          echo "=== Dynamic dependencies ==="
          otool -L build/ctools_mac_arm.plugin

      - name: Upload macOS ARM plugin
        uses: actions/upload-artifact@v4
        with:
          name: ctools_mac_arm
          path: build/ctools_mac_arm.plugin
          if-no-files-found: error

  # ===========================================================================
  # macOS Intel (x86_64) Build
  # ===========================================================================
  build-macos-intel:
    runs-on: macos-15-large  # Intel runner (x86_64)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenMP (libomp)
        run: |
          brew install libomp
          echo "LIBOMP_PREFIX=$(brew --prefix libomp)" >> $GITHUB_ENV

      - name: Build macOS Intel plugin
        run: make macos-intel

      - name: Verify build
        run: |
          ls -la build/
          file build/ctools_mac_x86.plugin

          echo ""
          echo "=== Checking OpenMP linking ==="
          if otool -L build/ctools_mac_x86.plugin | grep -q "libomp"; then
            echo "⚠ libomp is dynamically linked"
          else
            echo "✓ libomp is NOT in dynamic dependencies (statically linked)"
          fi

          echo ""
          echo "=== Dynamic dependencies ==="
          otool -L build/ctools_mac_x86.plugin

      - name: Upload macOS Intel plugin
        uses: actions/upload-artifact@v4
        with:
          name: ctools_mac_x86
          path: build/ctools_mac_x86.plugin
          if-no-files-found: error

  # ===========================================================================
  # Windows x64 Build
  # ===========================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-openmp
            mingw-w64-x86_64-winpthreads-git

      - name: Build Windows plugin
        shell: msys2 {0}
        run: |
          # Set compiler flags for Windows with OpenMP (statically linked)
          export CC=gcc
          export CFLAGS="-O3 -Wall -shared -DSYSTEM=STWIN32 -DSD_FASTMODE -fopenmp -ffast-math -funroll-loops -ftree-vectorize -fno-strict-aliasing"
          # Use -Wl,-Bstatic to force static linking of libgomp
          # This avoids runtime dependency on libgomp-1.dll
          export LDFLAGS="-static-libgcc -Wl,-Bstatic -lgomp -Wl,-Bdynamic -lpthread"

          # Build manually since Makefile detection might not work in MSYS2
          mkdir -p build

          # Get all source files
          SOURCES=$(find src -name "*.c" | tr '\n' ' ')
          INCLUDES="-Isrc -Isrc/csort -Isrc/cimport -Isrc/cimport/miniz -Isrc/cexport -Isrc/cmerge -Isrc/creghdfe -Isrc/cqreg -Isrc/cbinscatter -Isrc/civreghdfe -Isrc/cencode -Isrc/cwinsor -Isrc/cdestring -Isrc/cdecode -Isrc/csample -Isrc/cbsample -Isrc/crangestat"

          echo "Compiling with OpenMP support (statically linked)..."
          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"
          gcc $CFLAGS $INCLUDES -o build/ctools_windows.plugin $SOURCES $LDFLAGS

          echo "Build complete!"
          ls -la build/

      - name: Verify build
        shell: msys2 {0}
        run: |
          echo "=== File type ==="
          file build/ctools_windows.plugin

          echo ""
          echo "=== Checking OpenMP is statically linked ==="
          # Verify GOMP symbols are present (indicates OpenMP was compiled in)
          if nm build/ctools_windows.plugin | grep -q "GOMP_parallel"; then
            echo "✓ OpenMP symbols found (GOMP_parallel present)"
          else
            echo "✗ WARNING: OpenMP symbols NOT found"
          fi

          # Verify libgomp is NOT in DLL imports (confirms static linking)
          if objdump -p build/ctools_windows.plugin | grep -qi "libgomp"; then
            echo "✗ WARNING: libgomp found in DLL imports - OpenMP may be dynamically linked!"
          else
            echo "✓ libgomp NOT in DLL imports (confirms static linking)"
          fi

          echo ""
          echo "=== DLL dependencies ==="
          objdump -p build/ctools_windows.plugin | grep "DLL Name" || echo "No DLL dependencies found"

          echo ""
          echo "=== OpenMP function symbols (sample) ==="
          nm build/ctools_windows.plugin | grep -E "omp_get_max_threads|GOMP_parallel" | head -5 || echo "No OpenMP symbols found"

      - name: Upload Windows plugin
        uses: actions/upload-artifact@v4
        with:
          name: ctools_windows
          path: build/ctools_windows.plugin
          if-no-files-found: error

  # ===========================================================================
  # Combine all artifacts into single release package
  # ===========================================================================
  package:
    needs: [build-linux, build-macos-arm, build-macos-intel, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: plugins

      - name: Organize plugins
        run: |
          mkdir -p release/build

          # Move plugins to build directory
          cp plugins/ctools_linux/ctools_linux.plugin release/build/
          cp plugins/ctools_mac_arm/ctools_mac_arm.plugin release/build/
          cp plugins/ctools_mac_x86/ctools_mac_x86.plugin release/build/
          cp plugins/ctools_windows/ctools_windows.plugin release/build/

          # Copy ado and help files
          cp build/*.ado release/build/ 2>/dev/null || true
          cp build/*.sthlp release/build/ 2>/dev/null || true

          echo "Release package contents:"
          ls -la release/build/

      - name: Upload combined package
        uses: actions/upload-artifact@v4
        with:
          name: ctools-all-platforms
          path: release/
          if-no-files-found: error

  # ===========================================================================
  # Commit built plugins to repository
  # ===========================================================================
  commit-plugins:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: ctools-all-platforms
          path: release

      - name: Copy plugins to build directory
        run: |
          mkdir -p build
          cp release/build/*.plugin build/
          echo "Plugins copied to build/:"
          ls -la build/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f build/*.plugin
          git diff --staged --quiet || git commit -m "Update compiled plugins [skip ci]"
          git push

  # ===========================================================================
  # Create GitHub Release (only on release events)
  # ===========================================================================
  release:
    if: github.event_name == 'release'
    needs: [package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: ctools-all-platforms
          path: release

      - name: Create release archive
        run: |
          cd release
          zip -r ../ctools-${{ github.event.release.tag_name }}.zip build/
          cd ..
          ls -la *.zip

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: ctools-${{ github.event.release.tag_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
