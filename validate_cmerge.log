
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do validation/validate_cmerge.do 

. /****************************************************************************
> ***
>  * validate_cmerge.do
>  *
>  * Comprehensive validation tests for cmerge vs native merge
>  * Tests all merge types and options across multiple built-in Stata datasets
>  ****************************************************************************
> **/
. 
. do "validation/validate_setup.do"

. /****************************************************************************
> ***
>  * validate_setup.do
>  *
>  * Setup and helper programs for ctools validation test suite
>  * This file is included by all individual validation tests
>  ****************************************************************************
> **/
. 
. version 14.0

. clear all

. set more off

. set trace off

. 
. * Load ctools from build directory
. adopath + "build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "build"

. cap program drop ctools_plugin

. program ctools_plugin, plugin using("build/ctools_mac_arm.plugin")

. 
. * Global counters
. global TESTS_PASSED = 0

. global TESTS_FAILED = 0

. global TESTS_TOTAL = 0

. 
. * Helper program to compare scalars with tolerance
. capture program drop assert_scalar_equal

. program define assert_scalar_equal
  1.     args name val1 val2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     local diff = abs(`val1' - `val2')
  5.     * Handle exact match case (for integers like N)
.     if `diff' == 0 | `diff' < `tol' {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (`name' diff = " %12.2e `diff' ")
> "
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`name': `val1' vs `val2', diff = 
> " %12.2e `diff' ")"
 12.     }
 13. end

. 
. * Helper program to compare matrices
. capture program drop assert_matrix_equal

. program define assert_matrix_equal
  1.     args mat1 mat2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     tempname diff
  5.     matrix `diff' = `mat1' - `mat2'
  6.     local maxdiff = 0
  7.     local rows = rowsof(`diff')
  8.     local cols = colsof(`diff')
  9.     forvalues i = 1/`rows' {
 10.         forvalues j = 1/`cols' {
 11.             local d = abs(`diff'[`i', `j'])
 12.             if `d' > `maxdiff' local maxdiff = `d'
 13.         }
 14.     }
 15. 
.     if `maxdiff' < `tol' {
 16.         global TESTS_PASSED = $TESTS_PASSED + 1
 17.         di as result "  PASS: `testname' (max diff = " %12.2e `maxdiff' ")
> "
 18.     }
 19.     else {
 20.         global TESTS_FAILED = $TESTS_FAILED + 1
 21.         di as error "  FAIL: `testname' (max diff = " %12.2e `maxdiff' ")"
 22.     }
 23. end

. 
. * Helper program to compare variables
. capture program drop assert_var_equal

. program define assert_var_equal
  1.     args var1 var2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-10
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     quietly count if abs(`var1' - `var2') > `tol'
  5.     local ndiff = r(N)
  6. 
.     if `ndiff' == 0 {
  7.         global TESTS_PASSED = $TESTS_PASSED + 1
  8.         di as result "  PASS: `testname' (all values match)"
  9.     }
 10.     else {
 11.         global TESTS_FAILED = $TESTS_FAILED + 1
 12.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 13.     }
 14. end

. 
. * Helper program to compare string variables
. capture program drop assert_strvar_equal

. program define assert_strvar_equal
  1.     args var1 var2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     quietly count if `var1' != `var2'
  4.     local ndiff = r(N)
  5. 
.     if `ndiff' == 0 {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (all values match)"
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 12.     }
 13. end

. 
. * Helper to check if two datasets are identical (with fallback to sorted comp
> arison)
. capture program drop assert_data_equal

. program define assert_data_equal
  1.     args file1 file2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     preserve
  4.     capture quietly {
  5.         use "`file1'", clear
  6.         cf _all using "`file2'"
  7.     }
  8.     local rc = _rc
  9.     restore
 10. 
.     if `rc' == 0 {
 11.         global TESTS_PASSED = $TESTS_PASSED + 1
 12.         di as result "  PASS: `testname' (datasets identical)"
 13.     }
 14.     else {
 15.         * Try sorting both datasets by all variables before comparing
.         preserve
 16.         capture quietly {
 17.             use "`file1'", clear
 18.             ds
 19.             local allvars `r(varlist)'
 20.             sort `allvars'
 21.             tempfile sorted1
 22.             save `sorted1', replace
 23. 
.             use "`file2'", clear
 24.             sort `allvars'
 25.             cf _all using `sorted1'
 26.         }
 27.         local rc2 = _rc
 28.         restore
 29. 
.         if `rc2' == 0 {
 30.             global TESTS_PASSED = $TESTS_PASSED + 1
 31.             di as result "  PASS: `testname' (datasets identical after sor
> ting)"
 32.         }
 33.         else {
 34.             global TESTS_FAILED = $TESTS_FAILED + 1
 35.             di as error "  FAIL: `testname' (datasets differ even after so
> rting)"
 36.         }
 37.     }
 38. end

. 
. * Helper to compare datasets after sorting (for merges where row order may di
> ffer)
. capture program drop assert_data_equal_sorted

. program define assert_data_equal_sorted
  1.     args file1 file2 sortkey testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     preserve
  4.     quietly {
  5.         * Load and sort first file
.         use "`file1'", clear
  6.         sort `sortkey', stable
  7.         tempfile sorted1
  8.         save `sorted1'
  9. 
.         * Load and sort second file
.         use "`file2'", clear
 10.         sort `sortkey', stable
 11.         tempfile sorted2
 12.         save `sorted2'
 13. 
.         * Compare
.         use `sorted1', clear
 14.         cf _all using `sorted2'
 15.     }
 16.     local rc = _rc
 17.     restore
 18. 
.     if `rc' == 0 {
 19.         global TESTS_PASSED = $TESTS_PASSED + 1
 20.         di as result "  PASS: `testname' (datasets identical after sorting
> )"
 21.     }
 22.     else {
 23.         global TESTS_FAILED = $TESTS_FAILED + 1
 24.         di as error "  FAIL: `testname' (datasets differ even after sortin
> g)"
 25.     }
 26. end

. 
. * Helper to compare merge counts (for merges where row order may differ)
. capture program drop assert_merge_counts_equal

. program define assert_merge_counts_equal
  1.     args file1 file2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     preserve
  4.     quietly {
  5.         use "`file1'", clear
  6.         local n1 = _N
  7.         count if _merge == 1
  8.         local m1_1 = r(N)
  9.         count if _merge == 2
 10.         local m1_2 = r(N)
 11.         count if _merge == 3
 12.         local m1_3 = r(N)
 13. 
.         use "`file2'", clear
 14.         local n2 = _N
 15.         count if _merge == 1
 16.         local m2_1 = r(N)
 17.         count if _merge == 2
 18.         local m2_2 = r(N)
 19.         count if _merge == 3
 20.         local m2_3 = r(N)
 21.     }
 22.     restore
 23. 
.     local pass = (`n1' == `n2') & (`m1_1' == `m2_1') & (`m1_2' == `m2_2') & (
> `m1_3' == `m2_3')
 24. 
.     if `pass' {
 25.         global TESTS_PASSED = $TESTS_PASSED + 1
 26.         di as result "  PASS: `testname' (N=`n1', m1=`m1_1', m2=`m1_2', m3
> =`m1_3')"
 27.     }
 28.     else {
 29.         global TESTS_FAILED = $TESTS_FAILED + 1
 30.         di as error "  FAIL: `testname' counts differ"
 31.         di as error "    Stata: N=`n1', m1=`m1_1', m2=`m1_2', m3=`m1_3'"
 32.         di as error "    cmerge: N=`n2', m1=`m2_1', m2=`m2_2', m3=`m2_3'"
 33.     }
 34. end

. 
. * Helper program to print section header
. capture program drop print_section

. program define print_section
  1.     args title
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "`title'"
  5.     di as text "{hline 70}"
  6. end

. 
. * Helper program to print test summary
. capture program drop print_summary

. program define print_summary
  1.     args component
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "SUMMARY: `component'"
  5.     di as text "{hline 70}"
  6.     di as text "Tests passed: " as result $TESTS_PASSED
  7.     di as text "Tests failed: " as result $TESTS_FAILED
  8.     di as text "Total tests:  " as result $TESTS_TOTAL
  9.     if $TESTS_FAILED > 0 {
 10.         di as error "VALIDATION FAILED"
 11.     }
 12.     else {
 13.         di as result "ALL TESTS PASSED"
 14.     }
 15.     di as text "{hline 70}"
 16. end

. 
. * Create temp directory for test files
. capture mkdir "validation/temp"

. 
. di as text ""


. di as text "ctools validation framework loaded"
ctools validation framework loaded

. di as text ""


. 
end of do-file

. 
. di as text ""


. di as text "=================================================================
> ====="
======================================================================

. di as text "              CMERGE VALIDATION TEST SUITE"
              CMERGE VALIDATION TEST SUITE

. di as text "=================================================================
> ====="
======================================================================

. 
. * Create temp directory for test files
. capture mkdir "validation/temp"

. 
. /****************************************************************************
> ***
>  * SECTION 1: BASIC MERGE TYPES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 1: Basic 1:1 merge (auto dataset)
>  ****************************************************************************
> **/
. print_section "Test 1: Basic 1:1 merge (auto)"

----------------------------------------------------------------------
Test 1: Basic 1:1 merge (auto)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price mpg

. gen id = _n

. order id

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep make weight length

. gen id = _n

. order id

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Basic 1:1 merge"
  PASS: Basic 1:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 2: Basic m:1 merge (auto dataset)
>  ****************************************************************************
> **/
. print_section "Test 2: Basic m:1 merge (auto)"

----------------------------------------------------------------------
Test 2: Basic m:1 merge (auto)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price mpg foreign

. tempfile master

. quietly save `master'

. 
. clear

. input byte foreign str20 country

      foreign               country
  1. 0 "Domestic"
  2. 1 "Foreign"
  3. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge m:1 foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge m:1 foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Basic m:1 merge"
  PASS: Basic m:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 3: Basic 1:m merge (auto dataset)
>  ****************************************************************************
> **/
. print_section "Test 3: Basic 1:m merge (auto)"

----------------------------------------------------------------------
Test 3: Basic 1:m merge (auto)
----------------------------------------------------------------------

. 
. clear

. input byte foreign str20 region

      foreign                region
  1. 0 "Americas"
  2. 1 "International"
  3. end

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price foreign

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:m foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:m foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. * 1:m merge produces rows in different order than Stata, compare after sortin
> g
. assert_data_equal_sorted `stata_merged' `cmerge_merged' "foreign make" "Basic
>  1:m merge"
  PASS: Basic 1:m merge (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 4: m:m merge (auto dataset)
>  ****************************************************************************
> **/
. print_section "Test 4: m:m merge"

----------------------------------------------------------------------
Test 4: m:m merge
----------------------------------------------------------------------

. 
. clear

. input int group float value

        group      value
  1. 1 10
  2. 1 20
  3. 2 30
  4. 2 40
  5. end

. tempfile master

. quietly save `master'

. 
. clear

. input int group str10 label

        group       label
  1. 1 "A"
  2. 1 "B"
  3. 2 "C"
  4. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge m:m group using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge m:m group using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  (_merge==1)

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. * m:m merge results can be order-dependent, check counts
. use `stata_merged', clear

. local stata_n = _N

. use `cmerge_merged', clear

. local cmerge_n = _N

. 
. if `stata_n' == `cmerge_n' {
.     di as result "  PASS: m:m merge - observation counts match (`stata_n')"
  PASS: m:m merge - observation counts match (4)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: m:m merge - counts differ (stata=`stata_n', cmerge=`
> cmerge_n')"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SECTION 2: KEEP() OPTION TESTS
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 5: keep(match) option
>  ****************************************************************************
> **/
. print_section "Test 5: keep(match) option"

----------------------------------------------------------------------
Test 5: keep(match) option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n <= 50
(24 observations deleted)

. gen id = _n

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n >= 30
(29 observations deleted)

. gen id = _n + 29

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', keep(match)
(label origin already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', keep(match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            53
        from master                        29  (_merge==1)
        from using                         24  (_merge==2)

    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear
(1978 automobile data)

. local stata_n = _N

. use `cmerge_merged', clear
(1978 automobile data)

. local cmerge_n = _N

. 
. if `stata_n' == `cmerge_n' {
.     di as result "  PASS: keep(match) - observation counts match (`stata_n')"
  PASS: keep(match) - observation counts match (21)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: keep(match) - counts differ (stata=`stata_n', cmerge
> =`cmerge_n')"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 6: keep(master) option
>  ****************************************************************************
> **/
. print_section "Test 6: keep(master) option"

----------------------------------------------------------------------
Test 6: keep(master) option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n <= 50
(24 observations deleted)

. gen id = _n

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n >= 30
(29 observations deleted)

. gen id = _n + 29

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', keep(master)
(label origin already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            29
        from master                        29  (_merge==1)
        from using                          0  (_merge==2)

    Matched                                 0  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', keep(master)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            53
        from master                        29  (_merge==1)
        from using                         24  (_merge==2)

    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear
(1978 automobile data)

. local stata_n = _N

. use `cmerge_merged', clear
(1978 automobile data)

. local cmerge_n = _N

. 
. if `stata_n' == `cmerge_n' {
.     di as result "  PASS: keep(master) - observation counts match (`stata_n')
> "
  PASS: keep(master) - observation counts match (29)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: keep(master) - counts differ (stata=`stata_n', cmerg
> e=`cmerge_n')"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 7: keep(using) option
>  ****************************************************************************
> **/
. print_section "Test 7: keep(using) option"

----------------------------------------------------------------------
Test 7: keep(using) option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n <= 50
(24 observations deleted)

. gen id = _n

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n >= 30
(29 observations deleted)

. gen id = _n + 29

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', keep(using)
(label origin already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            24
        from master                         0  (_merge==1)
        from using                         24  (_merge==2)

    Matched                                 0  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', keep(using)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            53
        from master                        29  (_merge==1)
        from using                         24  (_merge==2)

    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear
(1978 automobile data)

. local stata_n = _N

. use `cmerge_merged', clear
(1978 automobile data)

. local cmerge_n = _N

. 
. if `stata_n' == `cmerge_n' {
.     di as result "  PASS: keep(using) - observation counts match (`stata_n')"
  PASS: keep(using) - observation counts match (24)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: keep(using) - counts differ (stata=`stata_n', cmerge
> =`cmerge_n')"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 8: keep(master match) combined
>  ****************************************************************************
> **/
. print_section "Test 8: keep(master match) combined"

----------------------------------------------------------------------
Test 8: keep(master match) combined
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n <= 50
(24 observations deleted)

. gen id = _n

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n >= 30
(29 observations deleted)

. gen id = _n + 29

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', keep(master match)
(label origin already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            29
        from master                        29  (_merge==1)
        from using                          0  (_merge==2)

    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            53
        from master                        29  (_merge==1)
        from using                         24  (_merge==2)

    Matched                                21  (_merge==3)
    -----------------------------------------

. drop _merge

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear
(1978 automobile data)

. local stata_n = _N

. use `cmerge_merged', clear
(1978 automobile data)

. local cmerge_n = _N

. 
. if `stata_n' == `cmerge_n' {
.     di as result "  PASS: keep(master match) - counts match (`stata_n')"
  PASS: keep(master match) - counts match (50)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: keep(master match) - counts differ"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SECTION 3: GENERATE/NOGENERATE OPTIONS
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 9: nogenerate option
>  ****************************************************************************
> **/
. print_section "Test 9: nogenerate option"

----------------------------------------------------------------------
Test 9: nogenerate option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id make price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id weight length

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `cmerge_merged', clear
(1978 automobile data)

. capture confirm variable _merge

. if _rc != 0 {
.     di as result "  PASS: nogenerate - _merge variable not created"
  PASS: nogenerate - _merge variable not created
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: nogenerate - _merge variable exists"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 10: generate() option
>  ****************************************************************************
> **/
. print_section "Test 10: generate() option"

----------------------------------------------------------------------
Test 10: generate() option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id make price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id weight

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', generate(merge_result)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (merge_result==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', generate(merge_result)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `cmerge_merged', clear
(1978 automobile data)

. capture confirm variable merge_result

. if _rc == 0 {
.     di as result "  PASS: generate() - custom merge variable created"
  PASS: generate() - custom merge variable created
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: generate() - custom merge variable not found"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 11: keepusing() option
>  ****************************************************************************
> **/
. print_section "Test 11: keepusing() option"

----------------------------------------------------------------------
Test 11: keepusing() option
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id make price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id weight length turn

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data', keepusing(weight)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data', keepusing(weight)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `cmerge_merged', clear
(1978 automobile data)

. capture confirm variable weight

. local has_weight = (_rc == 0)

. capture confirm variable length

. local has_length = (_rc == 0)

. capture confirm variable turn

. local has_turn = (_rc == 0)

. 
. if `has_weight' & !`has_length' & !`has_turn' {
.     di as result "  PASS: keepusing() - only specified variables merged"
  PASS: keepusing() - only specified variables merged
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: keepusing() - incorrect variables merged"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SECTION 4: MULTIPLE KEY VARIABLES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 12: Two key variables (nlswork panel)
>  ****************************************************************************
> **/
. print_section "Test 12: Two key variables (nlswork panel)"

----------------------------------------------------------------------
Test 12: Two key variables (nlswork panel)
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/2000
(26,534 observations deleted)

. keep idcode year ln_wage age

. tempfile master

. quietly save `master'

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/2000
(26,534 observations deleted)

. keep idcode year tenure ttl_exp

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. merge 1:1 idcode year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             2,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. cmerge 1:1 idcode year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             2,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Two key variables (idcode y
> ear)"
  PASS: Two key variables (idcode year) (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 13: Three key variables
>  ****************************************************************************
> **/
. print_section "Test 13: Three key variables"

----------------------------------------------------------------------
Test 13: Three key variables
----------------------------------------------------------------------

. 
. clear

. set obs 500
Number of observations (_N) was 0, now 500.

. gen id1 = mod(_n-1, 10) + 1

. gen id2 = mod(floor((_n-1)/10), 10) + 1

. gen id3 = floor((_n-1)/100) + 1

. gen value1 = runiform()

. tempfile master

. quietly save `master'

. 
. clear

. set obs 500
Number of observations (_N) was 0, now 500.

. gen id1 = mod(_n-1, 10) + 1

. gen id2 = mod(floor((_n-1)/10), 10) + 1

. gen id3 = floor((_n-1)/100) + 1

. gen value2 = runiform() * 100

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id1 id2 id3 using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               500  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id1 id2 id3 using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                               500  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Three key variables"
  PASS: Three key variables (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 14: String key variable
>  ****************************************************************************
> **/
. print_section "Test 14: String key variable (make)"

----------------------------------------------------------------------
Test 14: String key variable (make)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price mpg

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep make weight length

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 make using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 make using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "String key variable (make)"
  PASS: String key variable (make) (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 15: Mixed string and numeric keys
>  ****************************************************************************
> **/
. print_section "Test 15: Mixed string and numeric keys"

----------------------------------------------------------------------
Test 15: Mixed string and numeric keys
----------------------------------------------------------------------

. 
. sysuse census, clear
(1980 Census data by state)

. keep state region pop

. tempfile master

. quietly save `master'

. 
. sysuse census, clear
(1980 Census data by state)

. keep state region medage

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1980 Census data by state)

. merge 1:1 state region using `using_data'
(label cenreg already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1980 Census data by state)

. cmerge 1:1 state region using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Mixed string and numeric ke
> ys"
  PASS: Mixed string and numeric keys (datasets identical)

. 
. /****************************************************************************
> ***
>  * SECTION 5: EDGE CASES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 16: Merge with no matches
>  ****************************************************************************
> **/
. print_section "Test 16: Merge with no matches"

----------------------------------------------------------------------
Test 16: Merge with no matches
----------------------------------------------------------------------

. 
. clear

. input int id float value

           id      value
  1. 1 10
  2. 2 20
  3. 3 30
  4. end

. tempfile master

. quietly save `master'

. 
. clear

. input int id float other

           id      other
  1. 100 1.5
  2. 200 2.5
  3. 300 3.5
  4. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             6
        from master                         3  (_merge==1)
        from using                          3  (_merge==2)

    Matched                                 0  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             6
        from master                         3  (_merge==1)
        from using                          3  (_merge==2)

    Matched                                 0  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Merge with no matches"
  PASS: Merge with no matches (datasets identical)

. 
. use `cmerge_merged', clear

. quietly count if _merge == 3

. if r(N) == 0 {
.     di as result "  PASS: Correctly identified zero matches"
  PASS: Correctly identified zero matches
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Incorrectly reported matches"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 17: Merge with all matches
>  ****************************************************************************
> **/
. print_section "Test 17: Merge with all matches"

----------------------------------------------------------------------
Test 17: Merge with all matches
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id make price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id weight

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `cmerge_merged', clear
(1978 automobile data)

. quietly count if _merge != 3

. if r(N) == 0 {
.     di as result "  PASS: All observations matched (_merge == 3)"
  PASS: All observations matched (_merge == 3)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Some observations not matched"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 18: _merge values consistency
>  ****************************************************************************
> **/
. print_section "Test 18: _merge values consistency"

----------------------------------------------------------------------
Test 18: _merge values consistency
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n <= 40
(34 observations deleted)

. gen id = _n

. keep id price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep if _n >= 30
(29 observations deleted)

. gen id = _n + 29

. keep id weight

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            63
        from master                        29  (_merge==1)
        from using                         34  (_merge==2)

    Matched                                11  (_merge==3)
    -----------------------------------------

. 
. quietly count if _merge == 1

. local m1 = r(N)

. quietly count if _merge == 2

. local m2 = r(N)

. quietly count if _merge == 3

. local m3 = r(N)

. 
. * Expected: ids 1-29 master only, ids 30-40 matched, ids 41-74 using only
. local expected_m1 = 29

. local expected_m3 = 11

. local expected_m2 = 34

. 
. if `m1' == `expected_m1' & `m3' == `expected_m3' & `m2' == `expected_m2' {
.     di as result "  PASS: _merge values correct (m1=`m1', m2=`m2', m3=`m3')"
  PASS: _merge values correct (m1=29, m2=34, m3=11)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: _merge values incorrect"
.     di as error "    Expected: m1=`expected_m1', m2=`expected_m2', m3=`expect
> ed_m3'"
.     di as error "    Got:      m1=`m1', m2=`m2', m3=`m3'"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SECTION 6: BUILT-IN DATASET MERGES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 19: Census state to region merge
>  ****************************************************************************
> **/
. print_section "Test 19: Census state to region merge"

----------------------------------------------------------------------
Test 19: Census state to region merge
----------------------------------------------------------------------

. 
. sysuse census, clear
(1980 Census data by state)

. keep state region pop

. tempfile master

. quietly save `master'

. 
. clear

. input byte region str20 region_name

       region           region_name
  1. 1 "NE"
  2. 2 "N Cntrl"
  3. 3 "South"
  4. 4 "West"
  5. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1980 Census data by state)

. merge m:1 region using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1980 Census data by state)

. cmerge m:1 region using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Census state to region merg
> e"
  PASS: Census state to region merge (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 20: Auto - foreign to category merge
>  ****************************************************************************
> **/
. print_section "Test 20: Auto foreign to category merge"

----------------------------------------------------------------------
Test 20: Auto foreign to category merge
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price mpg foreign rep78

. tempfile master

. quietly save `master'

. 
. clear

. input byte foreign str30 origin_desc float import_tax

      foreign                     origin_desc  import_~x
  1. 0 "Made in USA" 0
  2. 1 "Imported" 0.05
  3. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge m:1 foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge m:1 foreign using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Auto foreign category merge
> "
  PASS: Auto foreign category merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 21: Auto - rep78 to quality rating merge
>  ****************************************************************************
> **/
. print_section "Test 21: Auto rep78 to quality rating merge"

----------------------------------------------------------------------
Test 21: Auto rep78 to quality rating merge
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make price mpg rep78

. tempfile master

. quietly save `master'

. 
. clear

. input byte rep78 str20 quality_desc

        rep78          quality_desc
  1. 1 "Poor"
  2. 2 "Fair"
  3. 3 "Average"
  4. 4 "Good"
  5. 5 "Excellent"
  6. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge m:1 rep78 using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             5
        from master                         5  (_merge==1)
        from using                          0  (_merge==2)

    Matched                                69  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge m:1 rep78 using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             5
        from master                         5  (_merge==1)

    Matched                                69  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Auto rep78 quality merge"
  PASS: Auto rep78 quality merge (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 22: Census - division expansion
>  ****************************************************************************
> **/
. print_section "Test 22: Census division 1:m merge"

----------------------------------------------------------------------
Test 22: Census division 1:m merge
----------------------------------------------------------------------

. 
. clear

. input byte region str20 division_name

       region         division_name
  1. 1 "Northeast"
  2. 2 "Midwest"
  3. 3 "South"
  4. 4 "West"
  5. end

. tempfile master

. quietly save `master'

. 
. sysuse census, clear
(1980 Census data by state)

. keep state region pop medage

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:m region using `using_data'
(variable region was byte, now int to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:m region using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Census division 1:m merge"
  PASS: Census division 1:m merge (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 23: Voter dataset merge
>  ****************************************************************************
> **/
. print_section "Test 23: Voter dataset 1:1 merge"

----------------------------------------------------------------------
Test 23: Voter dataset 1:1 merge
----------------------------------------------------------------------

. 
. sysuse voter, clear
(1992 US presidential voters)

. keep pop frac

. gen id = _n

. tempfile master

. quietly save `master'

. 
. sysuse voter, clear
(1992 US presidential voters)

. keep cand inc

. gen id = _n

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1992 US presidential voters)

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                15  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1992 US presidential voters)

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                15  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Voter dataset 1:1 merge"
  PASS: Voter dataset 1:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 24: US life expectancy merge
>  ****************************************************************************
> **/
. print_section "Test 24: US life expectancy time series merge"

----------------------------------------------------------------------
Test 24: US life expectancy time series merge
----------------------------------------------------------------------

. 
. sysuse uslifeexp, clear
(US life expectancy, 1900–1999)

. keep year le

. tempfile master

. quietly save `master'

. 
. sysuse uslifeexp, clear
(US life expectancy, 1900–1999)

. keep year le_male le_female

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(US life expectancy, 1900–1999)

. merge 1:1 year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               100  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(US life expectancy, 1900–1999)

. cmerge 1:1 year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                               100  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "US life expectancy merge"
  PASS: US life expectancy merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 25: SP500 stock data merge
>  ****************************************************************************
> **/
. print_section "Test 25: SP500 time series merge"

----------------------------------------------------------------------
Test 25: SP500 time series merge
----------------------------------------------------------------------

. 
. sysuse sp500, clear
(S&P 500)

. keep date open high

. tempfile master

. quietly save `master'

. 
. sysuse sp500, clear
(S&P 500)

. keep date low close volume

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(S&P 500)

. merge 1:1 date using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               248  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(S&P 500)

. cmerge 1:1 date using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                               248  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "SP500 time series merge"
  PASS: SP500 time series merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * SECTION 7: PANEL DATA MERGES (nlswork)
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 26: nlswork full panel merge
>  ****************************************************************************
> **/
. print_section "Test 26: nlswork panel 1:1 merge"

----------------------------------------------------------------------
Test 26: nlswork panel 1:1 merge
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/5000
(23,534 observations deleted)

. keep idcode year ln_wage hours

. tempfile master

. quietly save `master'

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/5000
(23,534 observations deleted)

. keep idcode year age tenure wks_work

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. merge 1:1 idcode year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             5,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. cmerge 1:1 idcode year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             5,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "nlswork panel 1:1 merge"
  PASS: nlswork panel 1:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 27: nlswork m:1 individual characteristics
>  ****************************************************************************
> **/
. print_section "Test 27: nlswork m:1 individual merge"

----------------------------------------------------------------------
Test 27: nlswork m:1 individual merge
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/3000
(25,534 observations deleted)

. keep idcode year ln_wage

. tempfile master

. quietly save `master'

. 
. * Create individual-level data (first obs per person)
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/3000
(25,534 observations deleted)

. bysort idcode (year): keep if _n == 1
(2,508 observations deleted)

. keep idcode race grade

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. merge m:1 idcode using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. cmerge m:1 idcode using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             3,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "nlswork m:1 individual merg
> e"
  PASS: nlswork m:1 individual merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 28: nlswork 1:m year characteristics
>  ****************************************************************************
> **/
. print_section "Test 28: nlswork 1:m year merge"

----------------------------------------------------------------------
Test 28: nlswork 1:m year merge
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. bysort year: keep if _n == 1
(28,519 observations deleted)

. keep year

. gen year_char = "Y" + string(year)

. tempfile master

. quietly save `master'

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/2000
(26,534 observations deleted)

. keep idcode year ln_wage

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. merge 1:m year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             2,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. cmerge 1:m year using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             2,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "nlswork 1:m year merge"
  PASS: nlswork 1:m year merge (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * SECTION 8: LARGE DATASET MERGES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 29: Large 1:1 merge (50K observations)
>  ****************************************************************************
> **/
. print_section "Test 29: Large 1:1 merge (50K obs)"

----------------------------------------------------------------------
Test 29: Large 1:1 merge (50K obs)
----------------------------------------------------------------------

. 
. clear

. set seed 12345

. set obs 50000
Number of observations (_N) was 0, now 50,000.

. gen id = _n

. gen value1 = runiform()

. gen value2 = runiformint(1, 100)

. tempfile master

. quietly save `master'

. 
. clear

. set obs 50000
Number of observations (_N) was 0, now 50,000.

. gen id = _n

. gen extra1 = runiform() * 100

. gen extra2 = runiformint(1, 1000)

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                            50,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear

. local stata_n = _N

. quietly count if _merge == 3

. local stata_m3 = r(N)

. 
. use `cmerge_merged', clear

. local cmerge_n = _N

. quietly count if _merge == 3

. local cmerge_m3 = r(N)

. 
. if `stata_n' == `cmerge_n' & `stata_m3' == `cmerge_m3' {
.     di as result "  PASS: Large 1:1 merge (N=`stata_n', matched=`stata_m3')"
  PASS: Large 1:1 merge (N=50000, matched=50000)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Large 1:1 merge counts differ"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 30: Large 1:m merge (50K x 10K)
>  ****************************************************************************
> **/
. print_section "Test 30: Large 1:m merge (50K x 10K)"

----------------------------------------------------------------------
Test 30: Large 1:m merge (50K x 10K)
----------------------------------------------------------------------

. 
. clear

. set seed 54321

. set obs 50000
Number of observations (_N) was 0, now 50,000.

. gen id = _n

. gen value1 = runiform()

. gen value2 = runiformint(1, 100)

. tempfile master

. quietly save `master'

. 
. clear

. set obs 10000
Number of observations (_N) was 0, now 10,000.

. gen id = runiformint(1, 50000)

. gen extra1 = runiform() * 100

. gen extra2 = "label" + string(runiformint(1, 500))

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:m id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                        40,968
        from master                    40,968  (_merge==1)
        from using                          0  (_merge==2)

    Matched                            10,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:m id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                        40,968
        from master                    40,968  (_merge==1)

    Matched                            10,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear

. local stata_n = _N

. quietly count if _merge == 1

. local stata_m1 = r(N)

. quietly count if _merge == 2

. local stata_m2 = r(N)

. quietly count if _merge == 3

. local stata_m3 = r(N)

. 
. use `cmerge_merged', clear

. local cmerge_n = _N

. quietly count if _merge == 1

. local cmerge_m1 = r(N)

. quietly count if _merge == 2

. local cmerge_m2 = r(N)

. quietly count if _merge == 3

. local cmerge_m3 = r(N)

. 
. local match = (`stata_n' == `cmerge_n') & (`stata_m1' == `cmerge_m1') & ///
>               (`stata_m2' == `cmerge_m2') & (`stata_m3' == `cmerge_m3')

. 
. if `match' {
.     di as result "  PASS: Large 1:m merge (N=`stata_n', m1=`stata_m1', m2=`st
> ata_m2', m3=`stata_m3')"
  PASS: Large 1:m merge (N=50968, m1=40968, m2=0, m3=10000)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Large 1:m merge counts differ"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 31: Large m:1 merge (100K x 1K)
>  ****************************************************************************
> **/
. print_section "Test 31: Large m:1 merge (100K x 1K)"

----------------------------------------------------------------------
Test 31: Large m:1 merge (100K x 1K)
----------------------------------------------------------------------

. 
. clear

. set seed 11111

. set obs 100000
Number of observations (_N) was 0, now 100,000.

. gen group_id = runiformint(1, 1000)

. gen value = runiform()

. tempfile master

. quietly save `master'

. 
. clear

. set obs 1000
Number of observations (_N) was 0, now 1,000.

. gen group_id = _n

. gen group_name = "Group" + string(group_id)

. gen group_weight = runiform()

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge m:1 group_id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           100,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge m:1 group_id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                           100,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear

. local stata_n = _N

. quietly count if _merge == 3

. local stata_m3 = r(N)

. 
. use `cmerge_merged', clear

. local cmerge_n = _N

. quietly count if _merge == 3

. local cmerge_m3 = r(N)

. 
. if `stata_n' == `cmerge_n' & `stata_m3' == `cmerge_m3' {
.     di as result "  PASS: Large m:1 merge (N=`stata_n', matched=`stata_m3')"
  PASS: Large m:1 merge (N=100000, matched=100000)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Large m:1 merge counts differ"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 32: Large merge with partial overlap
>  ****************************************************************************
> **/
. print_section "Test 32: Large merge with partial overlap"

----------------------------------------------------------------------
Test 32: Large merge with partial overlap
----------------------------------------------------------------------

. 
. clear

. set seed 22222

. set obs 30000
Number of observations (_N) was 0, now 30,000.

. gen id = _n

. gen value1 = runiform()

. tempfile master

. quietly save `master'

. 
. clear

. set obs 30000
Number of observations (_N) was 0, now 30,000.

. gen id = _n + 15000  // ids 15001-45000, overlaps with master 15001-30000

. gen value2 = runiform()

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                        30,000
        from master                    15,000  (_merge==1)
        from using                     15,000  (_merge==2)

    Matched                            15,000  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                        30,000
        from master                    15,000  (_merge==1)
        from using                     15,000  (_merge==2)

    Matched                            15,000  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear

. quietly count if _merge == 1

. local stata_m1 = r(N)

. quietly count if _merge == 2

. local stata_m2 = r(N)

. quietly count if _merge == 3

. local stata_m3 = r(N)

. 
. use `cmerge_merged', clear

. quietly count if _merge == 1

. local cmerge_m1 = r(N)

. quietly count if _merge == 2

. local cmerge_m2 = r(N)

. quietly count if _merge == 3

. local cmerge_m3 = r(N)

. 
. * Expected: 15000 master only, 15000 using only, 15000 matched
. if `stata_m1' == `cmerge_m1' & `stata_m2' == `cmerge_m2' & `stata_m3' == `cme
> rge_m3' {
.     di as result "  PASS: Partial overlap (m1=`cmerge_m1', m2=`cmerge_m2', m3
> =`cmerge_m3')"
  PASS: Partial overlap (m1=15000, m2=15000, m3=15000)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Partial overlap counts differ"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SECTION 9: STRING KEY MERGES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 33: Long string keys
>  ****************************************************************************
> **/
. print_section "Test 33: Long string keys"

----------------------------------------------------------------------
Test 33: Long string keys
----------------------------------------------------------------------

. 
. clear

. set obs 100
Number of observations (_N) was 0, now 100.

. gen str50 long_key = "prefix_" + string(_n, "%04.0f") + "_suffix_data"

. gen value1 = runiform()

. tempfile master

. quietly save `master'

. 
. clear

. set obs 100
Number of observations (_N) was 0, now 100.

. gen str50 long_key = "prefix_" + string(_n, "%04.0f") + "_suffix_data"

. gen value2 = runiform() * 100

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 long_key using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               100  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 long_key using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                               100  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Long string keys merge"
  PASS: Long string keys merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 34: Census state name merge
>  ****************************************************************************
> **/
. print_section "Test 34: Census state name 1:1 merge"

----------------------------------------------------------------------
Test 34: Census state name 1:1 merge
----------------------------------------------------------------------

. 
. sysuse census, clear
(1980 Census data by state)

. keep state pop

. tempfile master

. quietly save `master'

. 
. sysuse census, clear
(1980 Census data by state)

. keep state medage death marriage divorce

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1980 Census data by state)

. merge 1:1 state using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1980 Census data by state)

. cmerge 1:1 state using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                50  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Census state name 1:1 merge
> "
  PASS: Census state name 1:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 35: Auto make model merge
>  ****************************************************************************
> **/
. print_section "Test 35: Auto make 1:1 merge"

----------------------------------------------------------------------
Test 35: Auto make 1:1 merge
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. keep make mpg price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. keep make weight length turn displacement gear_ratio

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 make using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 make using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Auto make 1:1 merge"
  PASS: Auto make 1:1 merge (datasets identical)

. 
. /****************************************************************************
> ***
>  * SECTION 10: SPECIAL CASES
>  ****************************************************************************
> **/
. 
. /****************************************************************************
> ***
>  * TEST 36: Merge with missing key values
>  ****************************************************************************
> **/
. print_section "Test 36: Merge with missing key values"

----------------------------------------------------------------------
Test 36: Merge with missing key values
----------------------------------------------------------------------

. 
. clear

. input int id float value

           id      value
  1. 1 10
  2. 2 20
  3. . 30
  4. 4 40
  5. end

. tempfile master

. quietly save `master'

. 
. clear

. input int id float other

           id      other
  1. 1 100
  2. . 200
  3. 3 300
  4. 4 400
  5. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         1  (_merge==1)
        from using                          1  (_merge==2)

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         1  (_merge==1)
        from using                          1  (_merge==2)

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Merge with missing key valu
> es"
  PASS: Merge with missing key values (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 37: Merge with negative key values
>  ****************************************************************************
> **/
. print_section "Test 37: Merge with negative key values"

----------------------------------------------------------------------
Test 37: Merge with negative key values
----------------------------------------------------------------------

. 
. clear

. input int id float value

           id      value
  1. -5 10
  2. -2 20
  3. 0 30
  4. 2 40
  5. 5 50
  6. end

. tempfile master

. quietly save `master'

. 
. clear

. input int id float other

           id      other
  1. -5 100
  2. -1 200
  3. 0 300
  4. 1 400
  5. 5 500
  6. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         2  (_merge==1)
        from using                          2  (_merge==2)

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         2  (_merge==1)
        from using                          2  (_merge==2)

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Merge with negative keys"
  PASS: Merge with negative keys (datasets identical after sorting)

. 
. /****************************************************************************
> ***
>  * TEST 38: Merge with float key values
>  ****************************************************************************
> **/
. print_section "Test 38: Merge with float key values"

----------------------------------------------------------------------
Test 38: Merge with float key values
----------------------------------------------------------------------

. 
. clear

. input float id float value

            id      value
  1. 1.5 10
  2. 2.7 20
  3. 3.14159 30
  4. end

. tempfile master

. quietly save `master'

. 
. clear

. input float id float other

            id      other
  1. 1.5 100
  2. 2.7 200
  3. 3.14159 300
  4. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                 3  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Merge with float keys"
  PASS: Merge with float keys (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 39: Merge with duplicate values in non-key variables
>  ****************************************************************************
> **/
. print_section "Test 39: Merge with duplicate non-key values"

----------------------------------------------------------------------
Test 39: Merge with duplicate non-key values
----------------------------------------------------------------------

. 
. clear

. input int id float value str10 category

           id      value    category
  1. 1 100 "A"
  2. 2 100 "A"
  3. 3 100 "B"
  4. 4 200 "B"
  5. end

. tempfile master

. quietly save `master'

. 
. clear

. input int id float other str10 label

           id      other       label
  1. 1 50 "X"
  2. 2 50 "X"
  3. 3 75 "Y"
  4. 4 75 "Y"
  5. end

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                 4  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. assert_data_equal `stata_merged' `cmerge_merged' "Merge with duplicate non-ke
> y values"
  PASS: Merge with duplicate non-key values (datasets identical)

. 
. /****************************************************************************
> ***
>  * TEST 40: Very wide using dataset
>  ****************************************************************************
> **/
. print_section "Test 40: Wide using dataset (50 variables)"

----------------------------------------------------------------------
Test 40: Wide using dataset (50 variables)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. keep id make price

. tempfile master

. quietly save `master'

. 
. sysuse auto, clear
(1978 automobile data)

. gen id = _n

. drop make price mpg

. * Generate additional variables
. forval i = 1/40 {
  2.     gen extra`i' = runiform()
  3. }

. tempfile using_data

. quietly save `using_data'

. 
. use `master', clear
(1978 automobile data)

. merge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile stata_merged

. quietly save `stata_merged'

. 
. use `master', clear
(1978 automobile data)

. cmerge 1:1 id using `using_data'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                                74  (_merge==3)
    -----------------------------------------

. tempfile cmerge_merged

. quietly save `cmerge_merged'

. 
. use `stata_merged', clear
(1978 automobile data)

. local stata_nvars = c(k)

. use `cmerge_merged', clear
(1978 automobile data)

. local cmerge_nvars = c(k)

. 
. if `stata_nvars' == `cmerge_nvars' {
.     di as result "  PASS: Wide dataset merge (`stata_nvars' variables)"
  PASS: Wide dataset merge (53 variables)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Variable count mismatch"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SUMMARY
>  ****************************************************************************
> **/
. print_summary "cmerge"

----------------------------------------------------------------------
SUMMARY: cmerge
----------------------------------------------------------------------
Tests passed: 41
Tests failed: 0
Total tests:  41
ALL TESTS PASSED
----------------------------------------------------------------------

. 
. * Return error code if any tests failed
. if $TESTS_FAILED > 0 {
.     exit 1
. }

. 
end of do-file
