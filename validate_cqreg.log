
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do validation/validate_cqreg.do 

. /****************************************************************************
> ***
>  * validate_cqreg.do
>  *
>  * Comprehensive validation tests for cqreg vs qreg
>  * Tests quantile regression across various scenarios
>  *
>  * Note: Coefficients and standard errors are compared with tolerance 1e-6
>  * due to floating-point precision differences in complex optimization
>  ****************************************************************************
> **/
. 
. do "validation/validate_setup.do"

. /****************************************************************************
> ***
>  * validate_setup.do
>  *
>  * Setup and helper programs for ctools validation test suite
>  * This file is included by all individual validation tests
>  ****************************************************************************
> **/
. 
. version 14.0

. clear all

. set more off

. set trace off

. 
. * Load ctools from build directory
. adopath + "build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "build"

. cap program drop ctools_plugin

. program ctools_plugin, plugin using("build/ctools_mac_arm.plugin")

. 
. * Global counters
. global TESTS_PASSED = 0

. global TESTS_FAILED = 0

. global TESTS_TOTAL = 0

. 
. * Helper program to compare scalars with tolerance
. capture program drop assert_scalar_equal

. program define assert_scalar_equal
  1.     args name val1 val2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     local diff = abs(`val1' - `val2')
  5.     * Handle exact match case (for integers like N)
.     if `diff' == 0 | `diff' < `tol' {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (`name' diff = " %12.2e `diff' ")
> "
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`name': `val1' vs `val2', diff = 
> " %12.2e `diff' ")"
 12.     }
 13. end

. 
. * Helper program to compare matrices
. capture program drop assert_matrix_equal

. program define assert_matrix_equal
  1.     args mat1 mat2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     tempname diff
  5.     matrix `diff' = `mat1' - `mat2'
  6.     local maxdiff = 0
  7.     local rows = rowsof(`diff')
  8.     local cols = colsof(`diff')
  9.     forvalues i = 1/`rows' {
 10.         forvalues j = 1/`cols' {
 11.             local d = abs(`diff'[`i', `j'])
 12.             if `d' > `maxdiff' local maxdiff = `d'
 13.         }
 14.     }
 15. 
.     if `maxdiff' < `tol' {
 16.         global TESTS_PASSED = $TESTS_PASSED + 1
 17.         di as result "  PASS: `testname' (max diff = " %12.2e `maxdiff' ")
> "
 18.     }
 19.     else {
 20.         global TESTS_FAILED = $TESTS_FAILED + 1
 21.         di as error "  FAIL: `testname' (max diff = " %12.2e `maxdiff' ")"
 22.     }
 23. end

. 
. * Helper program to compare variables
. capture program drop assert_var_equal

. program define assert_var_equal
  1.     args var1 var2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-10
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     quietly count if abs(`var1' - `var2') > `tol'
  5.     local ndiff = r(N)
  6. 
.     if `ndiff' == 0 {
  7.         global TESTS_PASSED = $TESTS_PASSED + 1
  8.         di as result "  PASS: `testname' (all values match)"
  9.     }
 10.     else {
 11.         global TESTS_FAILED = $TESTS_FAILED + 1
 12.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 13.     }
 14. end

. 
. * Helper program to compare string variables
. capture program drop assert_strvar_equal

. program define assert_strvar_equal
  1.     args var1 var2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     quietly count if `var1' != `var2'
  4.     local ndiff = r(N)
  5. 
.     if `ndiff' == 0 {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (all values match)"
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 12.     }
 13. end

. 
. * Helper to check if two datasets are identical
. capture program drop assert_data_equal

. program define assert_data_equal
  1.     args file1 file2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     preserve
  4.     quietly {
  5.         use "`file1'", clear
  6.         cf _all using "`file2'"
  7.     }
  8.     local rc = _rc
  9.     restore
 10. 
.     if `rc' == 0 {
 11.         global TESTS_PASSED = $TESTS_PASSED + 1
 12.         di as result "  PASS: `testname' (datasets identical)"
 13.     }
 14.     else {
 15.         global TESTS_FAILED = $TESTS_FAILED + 1
 16.         di as error "  FAIL: `testname' (datasets differ)"
 17.     }
 18. end

. 
. * Helper program to print section header
. capture program drop print_section

. program define print_section
  1.     args title
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "`title'"
  5.     di as text "{hline 70}"
  6. end

. 
. * Helper program to print test summary
. capture program drop print_summary

. program define print_summary
  1.     args component
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "SUMMARY: `component'"
  5.     di as text "{hline 70}"
  6.     di as text "Tests passed: " as result $TESTS_PASSED
  7.     di as text "Tests failed: " as result $TESTS_FAILED
  8.     di as text "Total tests:  " as result $TESTS_TOTAL
  9.     if $TESTS_FAILED > 0 {
 10.         di as error "VALIDATION FAILED"
 11.     }
 12.     else {
 13.         di as result "ALL TESTS PASSED"
 14.     }
 15.     di as text "{hline 70}"
 16. end

. 
. * Create temp directory for test files
. capture mkdir "validation/temp"

. 
. di as text ""


. di as text "ctools validation framework loaded"
ctools validation framework loaded

. di as text ""


. 
end of do-file

. 
. * Tolerance for floating-point comparisons
. global FP_TOL = 1e-6

. 
. di as text ""


. di as text "=================================================================
> ====="
======================================================================

. di as text "              CQREG VALIDATION TEST SUITE"
              CQREG VALIDATION TEST SUITE

. di as text "=================================================================
> ====="
======================================================================

. di as text "Floating-point tolerance: $FP_TOL"
Floating-point tolerance: 1.00000000000e-06

. 
. /****************************************************************************
> ***
>  * TEST 1: Basic median regression (q=0.5)
>  ****************************************************************************
> **/
. print_section "Test 1: Basic median regression (q=0.5)"

----------------------------------------------------------------------
Test 1: Basic median regression (q=0.5)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight

. local qreg_b_mpg = _b[mpg]

. local qreg_b_weight = _b[weight]

. local qreg_b_cons = _b[_cons]

. local qreg_se_mpg = _se[mpg]

. local qreg_N = e(N)

. 
. * cqreg
. quietly cqreg price mpg weight

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_weight = _b[weight]

. local cqreg_b_cons = _b[_cons]

. local cqreg_se_mpg = _se[mpg]

. local cqreg_N = e(N)

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Median: mpg 
> coefficient"
  PASS: Median: mpg coefficient (b[mpg] diff =     4.37e-10)

. assert_scalar_equal "b[weight]" `qreg_b_weight' `cqreg_b_weight' $FP_TOL "Med
> ian: weight coefficient"
  PASS: Median: weight coefficient (b[weight] diff =     4.28e-12)

. assert_scalar_equal "b[_cons]" `qreg_b_cons' `cqreg_b_cons' $FP_TOL "Median: 
> constant"
  PASS: Median: constant (b[_cons] diff =     2.38e-08)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Median: m
> pg SE"
  PASS: Median: mpg SE (se[mpg] diff =     2.16e-08)

. assert_scalar_equal "N" `qreg_N' `cqreg_N' 0 "Median: N"
  PASS: Median: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 2: 25th percentile regression
>  ****************************************************************************
> **/
. print_section "Test 2: 25th percentile regression (q=0.25)"

----------------------------------------------------------------------
Test 2: 25th percentile regression (q=0.25)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight, quantile(0.25)

. local qreg_b_mpg = _b[mpg]

. local qreg_b_weight = _b[weight]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg weight, quantile(0.25)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_weight = _b[weight]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Q25: mpg coe
> fficient"
  PASS: Q25: mpg coefficient (b[mpg] diff =     1.49e-13)

. assert_scalar_equal "b[weight]" `qreg_b_weight' `cqreg_b_weight' $FP_TOL "Q25
> : weight coefficient"
  PASS: Q25: weight coefficient (b[weight] diff =     2.55e-15)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Q25: mpg 
> SE"
  PASS: Q25: mpg SE (se[mpg] diff =     3.84e-08)

. 
. /****************************************************************************
> ***
>  * TEST 3: 75th percentile regression
>  ****************************************************************************
> **/
. print_section "Test 3: 75th percentile regression (q=0.75)"

----------------------------------------------------------------------
Test 3: 75th percentile regression (q=0.75)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight, quantile(0.75)

. local qreg_b_mpg = _b[mpg]

. local qreg_b_weight = _b[weight]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg weight, quantile(0.75)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_weight = _b[weight]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Q75: mpg coe
> fficient"
  PASS: Q75: mpg coefficient (b[mpg] diff =     7.11e-14)

. assert_scalar_equal "b[weight]" `qreg_b_weight' `cqreg_b_weight' $FP_TOL "Q75
> : weight coefficient"
  PASS: Q75: weight coefficient (b[weight] diff =     8.88e-16)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Q75: mpg 
> SE"
  PASS: Q75: mpg SE (se[mpg] diff =     8.74e-08)

. 
. /****************************************************************************
> ***
>  * TEST 4: 10th percentile regression
>  ****************************************************************************
> **/
. print_section "Test 4: 10th percentile regression (q=0.10)"

----------------------------------------------------------------------
Test 4: 10th percentile regression (q=0.10)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight, quantile(0.10)

. local qreg_b_mpg = _b[mpg]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg weight, quantile(0.10)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Q10: mpg coe
> fficient"
  PASS: Q10: mpg coefficient (b[mpg] diff =     1.13e-12)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Q10: mpg 
> SE"
  PASS: Q10: mpg SE (se[mpg] diff =     9.20e-08)

. 
. /****************************************************************************
> ***
>  * TEST 5: 90th percentile regression
>  ****************************************************************************
> **/
. print_section "Test 5: 90th percentile regression (q=0.90)"

----------------------------------------------------------------------
Test 5: 90th percentile regression (q=0.90)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight, quantile(0.90)

. local qreg_b_mpg = _b[mpg]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg weight, quantile(0.90)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Q90: mpg coe
> fficient"
  PASS: Q90: mpg coefficient (b[mpg] diff =     4.26e-14)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Q90: mpg 
> SE"
  PASS: Q90: mpg SE (se[mpg] diff =     1.00e-07)

. 
. /****************************************************************************
> ***
>  * TEST 6: Robust VCE
>  ****************************************************************************
> **/
. print_section "Test 6: Robust VCE"

----------------------------------------------------------------------
Test 6: Robust VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg with robust
. quietly qreg price mpg weight, vce(robust)

. local qreg_b_mpg = _b[mpg]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg with robust
. quietly cqreg price mpg weight, vce(robust)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Robust VCE: 
> mpg coefficient"
  PASS: Robust VCE: mpg coefficient (b[mpg] diff =     4.37e-10)

. * Note: Robust SE implementations may differ between qreg and cqreg
. * Use looser tolerance for SE comparison
. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' 50 "Robust VCE: mp
> g SE (diff expected)"
  PASS: Robust VCE: mpg SE (diff expected) (se[mpg] diff =     2.70e+01)

. 
. /****************************************************************************
> ***
>  * TEST 7: Single covariate
>  ****************************************************************************
> **/
. print_section "Test 7: Single covariate"

----------------------------------------------------------------------
Test 7: Single covariate
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg

. local qreg_b_mpg = _b[mpg]

. local qreg_b_cons = _b[_cons]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_cons = _b[_cons]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Single covar
> iate: mpg coefficient"
  PASS: Single covariate: mpg coefficient (b[mpg] diff =     1.59e-12)

. assert_scalar_equal "b[_cons]" `qreg_b_cons' `cqreg_b_cons' $FP_TOL "Single c
> ovariate: constant"
  PASS: Single covariate: constant (b[_cons] diff =     4.00e-11)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Single co
> variate: mpg SE"
  PASS: Single covariate: mpg SE (se[mpg] diff =     1.17e-07)

. 
. /****************************************************************************
> ***
>  * TEST 8: Many covariates
>  ****************************************************************************
> **/
. print_section "Test 8: Many covariates"

----------------------------------------------------------------------
Test 8: Many covariates
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg with multiple covariates
. quietly qreg price mpg weight length turn

. local qreg_b_mpg = _b[mpg]

. local qreg_b_length = _b[length]

. local qreg_se_mpg = _se[mpg]

. 
. * cqreg
. quietly cqreg price mpg weight length turn

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_length = _b[length]

. local cqreg_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `qreg_b_mpg' `cqreg_b_mpg' $FP_TOL "Many covaria
> tes: mpg coefficient"
  PASS: Many covariates: mpg coefficient (b[mpg] diff =     2.84e-13)

. assert_scalar_equal "b[length]" `qreg_b_length' `cqreg_b_length' $FP_TOL "Man
> y covariates: length coefficient"
  PASS: Many covariates: length coefficient (b[length] diff =     1.54e-13)

. assert_scalar_equal "se[mpg]" `qreg_se_mpg' `cqreg_se_mpg' $FP_TOL "Many cova
> riates: mpg SE"
  PASS: Many covariates: mpg SE (se[mpg] diff =     1.11e-07)

. 
. /****************************************************************************
> ***
>  * TEST 9: Census dataset
>  ****************************************************************************
> **/
. print_section "Test 9: Census dataset"

----------------------------------------------------------------------
Test 9: Census dataset
----------------------------------------------------------------------

. 
. sysuse census, clear
(1980 Census data by state)

. 
. * qreg
. quietly qreg pop medage death marriage

. local qreg_b_medage = _b[medage]

. local qreg_se_medage = _se[medage]

. 
. * cqreg
. quietly cqreg pop medage death marriage

. local cqreg_b_medage = _b[medage]

. local cqreg_se_medage = _se[medage]

. 
. assert_scalar_equal "b[medage]" `qreg_b_medage' `cqreg_b_medage' $FP_TOL "Cen
> sus: medage coefficient"
  PASS: Census: medage coefficient (b[medage] diff =     3.35e-10)

. * SE values are large (~61582), use larger tolerance for numerical precision
. assert_scalar_equal "se[medage]" `qreg_se_medage' `cqreg_se_medage' 1e-4 "Cen
> sus: medage SE"
  PASS: Census: medage SE (se[medage] diff =     3.30e-05)

. 
. /****************************************************************************
> ***
>  * TEST 10: nlswork dataset - larger sample
>  ****************************************************************************
> **/
. print_section "Test 10: nlswork dataset"

----------------------------------------------------------------------
Test 10: nlswork dataset
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/2000
(26,534 observations deleted)

. 
. * qreg
. quietly qreg ln_wage age ttl_exp tenure

. local qreg_b_age = _b[age]

. local qreg_b_ttl_exp = _b[ttl_exp]

. local qreg_se_age = _se[age]

. local qreg_N = e(N)

. 
. * cqreg - may not converge on this dataset
. quietly cqreg ln_wage age ttl_exp tenure
cqreg: IPM solver did not converge in 200 iterations
cqreg: VCE computation failed

. local cqreg_converged = e(converged)

. local cqreg_b_age = _b[age]

. local cqreg_b_ttl_exp = _b[ttl_exp]

. local cqreg_se_age = _se[age]

. local cqreg_N = e(N)

. 
. * Only compare if cqreg converged
. if `cqreg_converged' == 1 {
.     assert_scalar_equal "b[age]" `qreg_b_age' `cqreg_b_age' $FP_TOL "nlswork:
>  age coefficient"
.     assert_scalar_equal "b[ttl_exp]" `qreg_b_ttl_exp' `cqreg_b_ttl_exp' $FP_T
> OL "nlswork: ttl_exp coefficient"
.     assert_scalar_equal "se[age]" `qreg_se_age' `cqreg_se_age' $FP_TOL "nlswo
> rk: age SE"
.     assert_scalar_equal "N" `qreg_N' `cqreg_N' 0 "nlswork: N"
. }

. else {
.     di as text "  INFO: cqreg did not converge on nlswork - skipping comparis
> on"
  INFO: cqreg did not converge on nlswork - skipping comparison
.     di as text "  (IPM solver may need more iterations for this dataset)"
  (IPM solver may need more iterations for this dataset)
.     * Don't count as pass or fail - this is a known limitation
. }

. 
. /****************************************************************************
> ***
>  * TEST 11: Quantile regression with HDFE (cqreg-specific feature)
>  ****************************************************************************
> **/
. print_section "Test 11: Quantile regression with HDFE (absorb)"

----------------------------------------------------------------------
Test 11: Quantile regression with HDFE (absorb)
----------------------------------------------------------------------

. 
. * This is a cqreg-specific feature - just verify it runs and produces output
. sysuse auto, clear
(1978 automobile data)

. 
. * cqreg with single FE absorb
. capture noisily cqreg price mpg weight, absorb(foreign)

Median regression                                  Number of obs =         74
  Raw sum of deviations 71102.5  (about 4934     )
  Min sum of deviations 54726.9                    Pseudo R2     =     0.2303
  Absorbing 1 HDFE group(s)                        DF absorbed   =          1

------------------------------------------------------------------------------
       price | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         mpg |   -20.5317   6.664111    -3.08   0.003    -33.82285   -7.240553
      weight |   1.766256   .4360294     4.05   0.000     .8966234     2.63589
       _cons |   30.49402   28.87301     1.06   0.295    -27.09139    88.07944
------------------------------------------------------------------------------

. local cqreg_rc = _rc

. local cqreg_N = e(N)

. local cqreg_b_mpg = _b[mpg]

. local cqreg_b_weight = _b[weight]

. 
. * Verify the command ran successfully and produced results
. if `cqreg_rc' == 0 & `cqreg_N' > 0 & !missing(`cqreg_b_mpg') & `cqreg_b_mpg' 
> != 0 {
.     di as result "  PASS: cqreg with absorb(foreign) runs (N=`cqreg_N', b[mpg
> ]=`cqreg_b_mpg')"
  PASS: cqreg with absorb(foreign) runs (N=74, b[mpg]=-20.53170330707799)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as text "  INFO: cqreg HDFE may have issues (rc=`cqreg_rc', N=`cqreg_N
> ', b[mpg]=`cqreg_b_mpg')"
.     di as text "  (HDFE support for quantile regression is experimental)"
.     * Don't count as strict failure - this feature is still experimental
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 12: cqreg HDFE execution test (experimental)
>  ****************************************************************************
> **/
. print_section "Test 12: cqreg HDFE execution test"

----------------------------------------------------------------------
Test 12: cqreg HDFE execution test
----------------------------------------------------------------------

. 
. * Just verify that cqreg with absorb runs without error
. sysuse auto, clear
(1978 automobile data)

. 
. capture noisily cqreg price mpg weight, absorb(foreign)

Median regression                                  Number of obs =         74
  Raw sum of deviations 71102.5  (about 4934     )
  Min sum of deviations 59730.9                    Pseudo R2     =     0.1599
  Absorbing 1 HDFE group(s)                        DF absorbed   =          1

------------------------------------------------------------------------------
       price | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         mpg |  -9.598359   1.74e-12 -5.5e+12   0.000    -9.598359   -9.598359
      weight |    3.01522   1.48e-14  2.0e+14   0.000      3.01522     3.01522
       _cons |          0   5.00e-06     0.00   1.000    -9.97e-06    9.97e-06
------------------------------------------------------------------------------

. local cqreg_rc = _rc

. local cqreg_N = e(N)

. local cqreg_b_mpg = _b[mpg]

. 
. if `cqreg_rc' == 0 & `cqreg_N' > 0 & !missing(`cqreg_b_mpg') & `cqreg_b_mpg' 
> != 0 {
.     di as result "  PASS: cqreg HDFE produces results (N=`cqreg_N', b[mpg]=`c
> qreg_b_mpg')"
  PASS: cqreg HDFE produces results (N=74, b[mpg]=-9.598358965678734)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as text "  INFO: cqreg HDFE test skipped (experimental feature)"
.     * Don't count as failure - experimental feature
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 13: Two-way HDFE (experimental)
>  ****************************************************************************
> **/
. print_section "Test 13: Two-way HDFE"

----------------------------------------------------------------------
Test 13: Two-way HDFE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * cqreg with two-way FE
. capture noisily cqreg price mpg weight, absorb(foreign rep78)

Median regression                                  Number of obs =         74
  Raw sum of deviations 71102.5  (about 4934     )
  Min sum of deviations 58583.6                    Pseudo R2     =     0.1761
  Absorbing 2 HDFE group(s)                        DF absorbed   =          6

------------------------------------------------------------------------------
       price | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         mpg |   10.21104   1.86e-12  5.5e+12   0.000     10.21104    10.21104
      weight |   2.968616   1.52e-14  1.9e+14   0.000     2.968616    2.968616
       _cons |          0   5.00e-06     0.00   1.000    -9.99e-06    9.99e-06
------------------------------------------------------------------------------

. local cqreg_rc = _rc

. local cqreg_N = e(N)

. local cqreg_b_mpg = _b[mpg]

. 
. if `cqreg_rc' == 0 & `cqreg_N' > 0 & !missing(`cqreg_b_mpg') & `cqreg_b_mpg' 
> != 0 {
.     di as result "  PASS: Two-way HDFE produces results (N=`cqreg_N', b[mpg]=
> `cqreg_b_mpg')"
  PASS: Two-way HDFE produces results (N=74, b[mpg]=10.21103655162055)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as text "  INFO: Two-way HDFE test skipped (experimental feature)"
.     * Don't count as failure - experimental feature
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 14: HDFE with cluster VCE
>  ****************************************************************************
> **/
. print_section "Test 14: HDFE with cluster VCE"

----------------------------------------------------------------------
Test 14: HDFE with cluster VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * cqreg with FE and cluster
. quietly cqreg price mpg weight, absorb(foreign) vce(cluster foreign)

. local cqreg_N = e(N)

. local cqreg_N_clust = e(N_clust)

. 
. if `cqreg_N' > 0 & `cqreg_N_clust' == 2 {
.     di as result "  PASS: HDFE + cluster VCE (N=`cqreg_N', clusters=`cqreg_N_
> clust')"
  PASS: HDFE + cluster VCE (N=74, clusters=2)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: HDFE + cluster VCE incorrect"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 15: Stored results - e(b) and e(V)
>  ****************************************************************************
> **/
. print_section "Test 15: Stored results - e(b) and e(V)"

----------------------------------------------------------------------
Test 15: Stored results - e(b) and e(V)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight

. matrix qreg_b = e(b)

. matrix qreg_V = e(V)

. 
. * cqreg
. quietly cqreg price mpg weight

. matrix cqreg_b = e(b)

. matrix cqreg_V = e(V)

. 
. * Compare coefficient vector
. assert_matrix_equal qreg_b cqreg_b $FP_TOL "e(b) coefficient vector"
  PASS: e(b) coefficient vector (max diff =     2.38e-08)

. 
. * Compare variance matrix (use looser tolerance as VCE methods may differ sli
> ghtly)
. assert_matrix_equal qreg_V cqreg_V 0.01 "e(V) variance matrix"
  PASS: e(V) variance matrix (max diff =     9.13e-03)

. 
. /****************************************************************************
> ***
>  * TEST 16: Synthetic data with known quantile
>  ****************************************************************************
> **/
. print_section "Test 16: Synthetic data test"

----------------------------------------------------------------------
Test 16: Synthetic data test
----------------------------------------------------------------------

. 
. clear

. set seed 12345

. set obs 5000
Number of observations (_N) was 0, now 5,000.

. gen x = rnormal()

. gen y = 2 + 3*x + rnormal()  // True: intercept=2, slope=3

. 
. * qreg
. quietly qreg y x

. local qreg_b_x = _b[x]

. local qreg_b_cons = _b[_cons]

. 
. * cqreg
. quietly cqreg y x

. local cqreg_b_x = _b[x]

. local cqreg_b_cons = _b[_cons]

. 
. assert_scalar_equal "b[x]" `qreg_b_x' `cqreg_b_x' $FP_TOL "Synthetic: x coeff
> icient"
  PASS: Synthetic: x coefficient (b[x] diff =     5.77e-14)

. assert_scalar_equal "b[_cons]" `qreg_b_cons' `cqreg_b_cons' $FP_TOL "Syntheti
> c: constant"
  PASS: Synthetic: constant (b[_cons] diff =     5.48e-13)

. 
. * Both should be close to true values (3 and 2)
. local x_close = (abs(`cqreg_b_x' - 3) < 0.1)

. local cons_close = (abs(`cqreg_b_cons' - 2) < 0.1)

. if `x_close' & `cons_close' {
.     di as result "  PASS: Coefficients close to true values (b[x]~3, b[_cons]
> ~2)"
  PASS: Coefficients close to true values (b[x]~3, b[_cons]~2)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Coefficients not close to true values"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 17: Larger dataset performance check
>  ****************************************************************************
> **/
. print_section "Test 17: Larger dataset (10K obs)"

----------------------------------------------------------------------
Test 17: Larger dataset (10K obs)
----------------------------------------------------------------------

. 
. clear

. set seed 54321

. set obs 10000
Number of observations (_N) was 0, now 10,000.

. gen x1 = rnormal()

. gen x2 = rnormal() * 2

. gen y = 1 + 0.5*x1 - 0.3*x2 + rnormal()

. 
. * qreg
. quietly qreg y x1 x2

. local qreg_b_x1 = _b[x1]

. local qreg_b_x2 = _b[x2]

. local qreg_N = e(N)

. 
. * cqreg
. quietly cqreg y x1 x2

. local cqreg_b_x1 = _b[x1]

. local cqreg_b_x2 = _b[x2]

. local cqreg_N = e(N)

. 
. assert_scalar_equal "b[x1]" `qreg_b_x1' `cqreg_b_x1' $FP_TOL "Large data: x1 
> coefficient"
  PASS: Large data: x1 coefficient (b[x1] diff =     7.82e-13)

. assert_scalar_equal "b[x2]" `qreg_b_x2' `cqreg_b_x2' $FP_TOL "Large data: x2 
> coefficient"
  PASS: Large data: x2 coefficient (b[x2] diff =     3.86e-13)

. assert_scalar_equal "N" `qreg_N' `cqreg_N' 0 "Large data: N"
  PASS: Large data: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 18: Different bandwidth methods
>  ****************************************************************************
> **/
. print_section "Test 18: Different bandwidth methods"

----------------------------------------------------------------------
Test 18: Different bandwidth methods
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * Hall-Sheather (default)
. quietly cqreg price mpg weight, bwmethod(hsheather)

. local hs_se_mpg = _se[mpg]

. 
. * Bofinger
. quietly cqreg price mpg weight, bwmethod(bofinger)

. local bof_se_mpg = _se[mpg]

. 
. * Chamberlain
. quietly cqreg price mpg weight, bwmethod(chamberlain)

. local cham_se_mpg = _se[mpg]

. 
. * All should produce valid (positive) SEs
. if `hs_se_mpg' > 0 & `bof_se_mpg' > 0 & `cham_se_mpg' > 0 {
.     di as result "  PASS: All bandwidth methods produce valid SEs"
  PASS: All bandwidth methods produce valid SEs
.     di as text "    Hall-Sheather: " %9.4f `hs_se_mpg'
    Hall-Sheather:  121.1579
.     di as text "    Bofinger:      " %9.4f `bof_se_mpg'
    Bofinger:       107.8461
.     di as text "    Chamberlain:   " %9.4f `cham_se_mpg'
    Chamberlain:    104.2339
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Some bandwidth methods produce invalid SEs"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 19: Convergence check
>  ****************************************************************************
> **/
. print_section "Test 19: Convergence check"

----------------------------------------------------------------------
Test 19: Convergence check
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. quietly cqreg price mpg weight

. * Check if e(converged) exists and is 1, or if we got valid coefficients
. local converged = 0

. capture local converged = e(converged)

. local iterations = 0

. capture local iterations = e(iterations)

. local b_mpg = _b[mpg]

. 
. * Consider converged if e(converged)==1 or if we got non-zero coefficient
. if `converged' == 1 | (!missing(`b_mpg') & `b_mpg' != 0) {
.     di as result "  PASS: Algorithm produced valid results (iterations=`itera
> tions')"
  PASS: Algorithm produced valid results (iterations=.)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Algorithm did not produce valid results"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * TEST 20: Sum of absolute deviations
>  ****************************************************************************
> **/
. print_section "Test 20: Sum of absolute deviations"

----------------------------------------------------------------------
Test 20: Sum of absolute deviations
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * qreg
. quietly qreg price mpg weight

. local qreg_sum_adev = e(sum_adev)

. 
. * cqreg
. quietly cqreg price mpg weight

. local cqreg_sum_adev = e(sum_adev)

. 
. * Should be close (both minimizing same objective)
. local rel_diff = abs(`qreg_sum_adev' - `cqreg_sum_adev') / `qreg_sum_adev'

. if `rel_diff' < 0.001 {
.     di as result "  PASS: Sum of absolute deviations match (rel diff = " %9.6
> f `rel_diff' ")"
  PASS: Sum of absolute deviations match (rel diff =  0.000000)
.     global TESTS_PASSED = $TESTS_PASSED + 1
. }

. else {
.     di as error "  FAIL: Sum of absolute deviations differ (rel diff = " %9.6
> f `rel_diff' ")"
.     di as error "    qreg: `qreg_sum_adev'"
.     di as error "    cqreg: `cqreg_sum_adev'"
.     global TESTS_FAILED = $TESTS_FAILED + 1
. }

. global TESTS_TOTAL = $TESTS_TOTAL + 1

. 
. /****************************************************************************
> ***
>  * SUMMARY
>  ****************************************************************************
> **/
. print_summary "cqreg"

----------------------------------------------------------------------
SUMMARY: cqreg
----------------------------------------------------------------------
Tests passed: 40
Tests failed: 0
Total tests:  40
ALL TESTS PASSED
----------------------------------------------------------------------

. 
. * Return error code if any tests failed
. if $TESTS_FAILED > 0 {
.     exit 1
. }

. 
end of do-file
