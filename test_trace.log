
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do /tmp/test_trace.do 

. * Trace test
. clear all

. set more off

. adopath + "/Users/Mike/Documents/GitHub/stata-ctools/build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/Mike/Documents/GitHub/stata-ctools/build"

. 
. set seed 12345

. set obs 500
Number of observations (_N) was 0, now 500.

. gen firm = ceil(_n/10)

. gen z1 = rnormal()

. gen z2 = rnormal()

. gen x = rnormal()

. gen u = rnormal()

. gen endog_x = 0.5*z1 + 0.3*z2 + 0.2*u

. gen y = 1 + 2*endog_x + 1.5*x + 0.5*u + rnormal()

. 
. set trace on

. set tracedepth 3

. civreghdfe y x (endog_x = z1 z2), absorb(firm)
  -------------------------------------------------------- begin civreghdfe ---
  - version 14.0
  - syntax anything(name=0 equalok) [if] [in] [aw fw pw/], Absorb(varlist) [vce
> (string) TOLerance(real 1e-8) MAXiter(integer 500) Verbose TIMEit FIRST RF SM
> ALL LIML FULLER(real 0) Kclass(real 0) GMM2s CUE COVIV BW(integer 0) KERNEL(s
> tring) DKRAAY(integer 0) RESiduals(name) NOConstant]
  - if "`timeit'" != "" {
  = if "" != "" {
    local t0 = clock("", "hms")
    }
  - local 0 `"`0'"'
  = local 0 `"y x (endog_x = z1 z2)"'
  - gettoken depvar rest : 0, parse("(")
  - local depvar = strtrim("`depvar'")
  = local depvar = strtrim("y x ")
  - if strpos("`rest'", "(") == 0 {
  = if strpos("(endog_x = z1 z2)", "(") == 0 {
    di as error "civreghdfe requires (endogvars = instruments) specification"
    exit 198
    }
  - local rest = strtrim("`rest'")
  = local rest = strtrim("(endog_x = z1 z2)")
  - if substr("`rest'", 1, 1) == "(" {
  = if substr("(endog_x = z1 z2)", 1, 1) == "(" {
  - local rest = substr("`rest'", 2, .)
  = local rest = substr("(endog_x = z1 z2)", 2, .)
  - }
  - local paren_end = strpos("`rest'", ")")
  = local paren_end = strpos("endog_x = z1 z2)", ")")
  - if `paren_end' == 0 {
  = if 16 == 0 {
    di as error "Unmatched parenthesis in variable specification"
    exit 198
    }
  - local paren_content = substr("`rest'", 1, `paren_end' - 1)
  = local paren_content = substr("endog_x = z1 z2)", 1, 16 - 1)
  - local exogvars = strtrim(substr("`rest'", `paren_end' + 1, .))
  = local exogvars = strtrim(substr("endog_x = z1 z2)", 16 + 1, .))
  - local eq_pos = strpos("`paren_content'", "=")
  = local eq_pos = strpos("endog_x = z1 z2", "=")
  - if `eq_pos' == 0 {
  = if 9 == 0 {
    di as error "Must specify instruments after '=' in parentheses"
    exit 198
    }
  - local endogvars = strtrim(substr("`paren_content'", 1, `eq_pos' - 1))
  = local endogvars = strtrim(substr("endog_x = z1 z2", 1, 9 - 1))
  - local instruments = strtrim(substr("`paren_content'", `eq_pos' + 1, .))
  = local instruments = strtrim(substr("endog_x = z1 z2", 9 + 1, .))
  - foreach v of local depvar {
  - confirm numeric variable `v'
  = confirm numeric variable y
  - }
  - confirm numeric variable `v'
  = confirm numeric variable x
  - }
  - foreach v of local endogvars {
  - confirm numeric variable `v'
  = confirm numeric variable endog_x
  - }
  - foreach v of local instruments {
  - confirm numeric variable `v'
  = confirm numeric variable z1
  - }
  - confirm numeric variable `v'
  = confirm numeric variable z2
  - }
  - foreach v of local exogvars {
    confirm numeric variable `v'
    }
  - foreach v of local absorb {
  - confirm variable `v'
  = confirm variable firm
  - }
  - capture program list ctools_plugin
  - if _rc != 0 {
  - local __os = c(os)
  - local __machine = c(machine_type)
  - local __is_mac = 0
  - if "`__os'" == "MacOSX" {
  = if "Unix" == "MacOSX" {
    local __is_mac = 1
    }
  - else if strpos(lower("`__machine'"), "mac") > 0 {
  = else if strpos(lower("Mac (Apple Silicon)"), "mac") > 0 {
  - local __is_mac = 1
  - }
  - local __plugin = ""
  - if "`__os'" == "Windows" {
  = if "Unix" == "Windows" {
    local __plugin "ctools_windows.plugin"
    }
  - else if `__is_mac' {
  = else if 1 {
  - local __is_arm = 0
  - if strpos(lower("`__machine'"), "apple") > 0 | strpos(lower("`__machine'"),
>  "arm") > 0 | strpos(lower("`__machine'"), "silicon") > 0 {
  = if strpos(lower("Mac (Apple Silicon)"), "apple") > 0 | strpos(lower("Mac (A
> pple Silicon)"), "arm") > 0 | strpos(lower("Mac (Apple Silicon)"), "silicon")
>  > 0 {
  - local __is_arm = 1
  - }
  - if `__is_arm' == 0 {
  = if 1 == 0 {
    tempfile __archfile
    quietly shell uname -m > "`__archfile'" 2>&1
    tempname __fh
    file open `__fh' using "`__archfile'", read text
    file read `__fh' __archline
    file close `__fh'
    capture erase "`__archfile'"
    if strpos("`__archline'", "arm64") > 0 {
    local __is_arm = 1
    }
    }
  - if `__is_arm' {
  = if 1 {
  - local __plugin "ctools_mac_arm.plugin"
  - }
  - else {
    local __plugin "ctools_mac_x86.plugin"
    }
  - }
  - else if "`__os'" == "Unix" {
  = else if "Unix" == "Unix" {
    local __plugin "ctools_linux.plugin"
    }
  - else {
    local __plugin "ctools.plugin"
    }
  - capture program ctools_plugin, plugin using("`__plugin'")
  = capture program ctools_plugin, plugin using("ctools_mac_arm.plugin")
  - if _rc != 0 & _rc != 110 & "`__plugin'" != "ctools.plugin" {
  = if _rc != 0 & _rc != 110 & "ctools_mac_arm.plugin" != "ctools.plugin" {
    capture program ctools_plugin, plugin using("ctools.plugin")
    }
  - if _rc != 0 & _rc != 110 {
    di as error "civreghdfe: Could not load ctools plugin"
    exit 601
    }
  - }
  - local K_endog : word count `endogvars'
  = local K_endog : word count endog_x
  - local K_exog : word count `exogvars'
  = local K_exog : word count 
  - local K_inst_excl : word count `instruments'
  = local K_inst_excl : word count z1 z2
  - local G : word count `absorb'
  = local G : word count firm
  - local all_instruments `exogvars' `instruments'
  = local all_instruments  z1 z2
  - local K_iv : word count `all_instruments'
  = local K_iv : word count z1 z2
  - if `K_iv' < `K_endog' + `K_exog' {
  = if 2 < 1 + 0 {
    di as error "Model is underidentified"
    di as error "  Endogenous variables: `K_endog'"
    di as error "  Exogenous variables: `K_exog'"
    di as error "  Total instruments: `K_iv'"
    exit 481
    }
  - local vce_type = 0
  - local cluster_var ""
  - if `"`vce'"' != "" {
  = if `""' != "" {
    local vce_lower = lower(`"`vce'"')
    if `"`vce_lower'"' == "robust" | `"`vce_lower'"' == "r" {
    local vce_type = 1
    }
    else if substr(`"`vce_lower'"', 1, 2) == "cl" {
    local vce_type = 2
    local cluster_spec `"`vce'"'
    gettoken vce_cmd cluster_var : cluster_spec, parse(" (")
    local cluster_var = strtrim(subinstr("`cluster_var'", "(", "", .))
    local cluster_var = strtrim(subinstr("`cluster_var'", ")", "", .))
    confirm variable `cluster_var'
    }
    else if `"`vce_lower'"' == "unadjusted" | `"`vce_lower'"' == "ols" {
    local vce_type = 0
    }
    else {
    di as error "vce(`vce') not supported. Use vce(robust) or vce(cluster varna
> me)"
    exit 198
    }
    }
  - local has_weights = 0
  - local weight_type = 0
  - local weight_var ""
  - if "`weight'" != "" {
  = if "" != "" {
    local has_weights = 1
    if "`weight'" == "aweight" local weight_type = 1
    else if "`weight'" == "fweight" local weight_type = 2
    else if "`weight'" == "pweight" local weight_type = 3
    else {
    di as error "Weight type `weight' not supported"
    exit 198
    }
    local weight_var `"`exp'"'
    confirm numeric variable `weight_var'
    }
  - marksample touse
  - markout `touse' `depvar' `endogvars' `exogvars' `instruments' `absorb'
  = markout __000001 y x endog_x  z1 z2 firm
  - if "`cluster_var'" != "" {
  = if "" != "" {
    markout `touse' `cluster_var'
    }
  - if `has_weights' {
  = if 0 {
    markout `touse' `weight_var'
    }
  - qui count if `touse'
  = qui count if __000001
  - local N = r(N)
  - if `N' == 0 {
  = if 500 == 0 {
    di as error "No observations"
    exit 2000
    }
  - if "`verbose'" != "" {
  = if "" != "" {
    di as text ""
    di as text "{hline 60}"
    di as text "civreghdfe: C-Accelerated IV Regression with HDFE"
    di as text "{hline 60}"
    di as text "Dependent variable:    `depvar'"
    di as text "Endogenous variables:  `endogvars' (`K_endog')"
    di as text "Exogenous variables:   `exogvars' (`K_exog')"
    di as text "Excluded instruments:  `instruments' (`K_inst_excl')"
    di as text "Absorbed FE:           `absorb' (`G')"
    di as text "Observations:          `N'"
    if `vce_type' == 1 {
    di as text "VCE:                   Robust"
    }
    else if `vce_type' == 2 {
    di as text "VCE:                   Cluster (`cluster_var')"
    }
    else {
    di as text "VCE:                   Unadjusted"
    }
    di as text "{hline 60}"
    }
  - local nested_fe_index = 0
  - if `vce_type' == 2 & "`cluster_var'" != "" {
  = if 0 == 2 & "" != "" {
    local fe_idx = 1
    foreach fe_var of local absorb {
    if "`fe_var'" == "`cluster_var'" {
    local nested_fe_index = `fe_idx'
    }
    local fe_idx = `fe_idx' + 1
    }
    }
  - local est_method = 0
  - local kclass_val = 0
  - local fuller_val = 0
  - if "`liml'" != "" {
  = if "" != "" {
    local est_method = 1
    if "`verbose'" != "" {
    di as text "Estimation method:     LIML"
    }
    }
  - else if `fuller' != 0 {
  = else if 0 != 0 {
    local est_method = 2
    local fuller_val = `fuller'
    if "`verbose'" != "" {
    di as text "Estimation method:     Fuller LIML (alpha=`fuller')"
    }
    }
  - else if `kclass' != 0 {
  = else if 0 != 0 {
    local est_method = 3
    local kclass_val = `kclass'
    if "`verbose'" != "" {
    di as text "Estimation method:     k-class (k=`kclass')"
    }
    }
  - else if "`gmm2s'" != "" {
  = else if "" != "" {
    local est_method = 4
    if "`verbose'" != "" {
    di as text "Estimation method:     Two-step GMM"
    }
    }
  - else if "`cue'" != "" {
  = else if "" != "" {
    local est_method = 5
    if "`verbose'" != "" {
    di as text "Estimation method:     CUE (Continuously Updated GMM)"
    }
    }
  - else {
  - if "`verbose'" != "" {
  = if "" != "" {
    di as text "Estimation method:     2SLS"
    }
  - }
  - scalar __civreghdfe_K_endog = `K_endog'
  = scalar __civreghdfe_K_endog = 1
  - scalar __civreghdfe_K_exog = `K_exog'
  = scalar __civreghdfe_K_exog = 0
  - scalar __civreghdfe_K_iv = `K_iv'
  = scalar __civreghdfe_K_iv = 2
  - scalar __civreghdfe_G = `G'
  = scalar __civreghdfe_G = 1
  - scalar __civreghdfe_has_cluster = (`vce_type' == 2)
  = scalar __civreghdfe_has_cluster = (0 == 2)
  - scalar __civreghdfe_has_weights = `has_weights'
  = scalar __civreghdfe_has_weights = 0
  - scalar __civreghdfe_weight_type = `weight_type'
  = scalar __civreghdfe_weight_type = 0
  - scalar __civreghdfe_vce_type = `vce_type'
  = scalar __civreghdfe_vce_type = 0
  - scalar __civreghdfe_maxiter = `maxiter'
  = scalar __civreghdfe_maxiter = 500
  - scalar __civreghdfe_tolerance = `tolerance'
  = scalar __civreghdfe_tolerance = 1.00000000000e-08
  - scalar __civreghdfe_verbose = ("`verbose'" != "")
  = scalar __civreghdfe_verbose = ("" != "")
  - scalar __civreghdfe_nested_fe_index = `nested_fe_index'
  = scalar __civreghdfe_nested_fe_index = 0
  - scalar __civreghdfe_est_method = `est_method'
  = scalar __civreghdfe_est_method = 0
  - scalar __civreghdfe_kclass = `kclass_val'
  = scalar __civreghdfe_kclass = 0
  - scalar __civreghdfe_fuller = `fuller_val'
  = scalar __civreghdfe_fuller = 0
  - scalar __civreghdfe_coviv = ("`coviv'" != "")
  = scalar __civreghdfe_coviv = ("" != "")
  - local kernel_type = 0
  - local bw_val = `bw'
  = local bw_val = 0
  - local dkraay_val = `dkraay'
  = local dkraay_val = 0
  - if "`kernel'" != "" {
  = if "" != "" {
    local kernel_lower = lower("`kernel'")
    if "`kernel_lower'" == "bartlett" | "`kernel_lower'" == "nwest" {
    local kernel_type = 1
    }
    else if "`kernel_lower'" == "parzen" {
    local kernel_type = 2
    }
    else if "`kernel_lower'" == "quadraticspectral" | "`kernel_lower'" == "qs" 
> {
    local kernel_type = 3
    }
    else if "`kernel_lower'" == "truncated" | "`kernel_lower'" == "trunc" {
    local kernel_type = 4
    }
    else if "`kernel_lower'" == "tukey" | "`kernel_lower'" == "thann" {
    local kernel_type = 5
    }
    else {
    di as error "Unknown kernel type: `kernel'"
    di as error "Valid options: bartlett, parzen, quadraticspectral, truncated,
>  tukey"
    exit 198
    }
    }
  - if `dkraay_val' > 0 & `kernel_type' == 0 {
  = if 0 > 0 & 0 == 0 {
    local kernel_type = 1
    }
  - if `kernel_type' > 0 & `bw_val' == 0 {
  = if 0 > 0 & 0 == 0 {
    local bw_val = floor(4 * (`N'/100)^(2/9))
    if `bw_val' < 1 local bw_val = 1
    }
  - scalar __civreghdfe_kernel = `kernel_type'
  = scalar __civreghdfe_kernel = 0
  - scalar __civreghdfe_bw = `bw_val'
  = scalar __civreghdfe_bw = 0
  - scalar __civreghdfe_dkraay = `dkraay_val'
  = scalar __civreghdfe_dkraay = 0
  - if "`verbose'" != "" & `kernel_type' > 0 {
  = if "" != "" & 0 > 0 {
    di as text "HAC: kernel=`kernel_type', bandwidth=`bw_val'"
    if `dkraay_val' > 0 {
    di as text "Driscoll-Kraay standard errors with lag `dkraay_val'"
    }
    }
  - local K_total = `K_endog' + `K_exog'
  = local K_total = 1 + 0
  - tempname b_temp V_temp
  - matrix `b_temp' = J(1, `K_total', 0)
  = matrix __000002 = J(1, 1, 0)
  - matrix `V_temp' = J(`K_total', `K_total', 0)
  = matrix __000003 = J(1, 1, 0)
  - matrix __civreghdfe_b = `b_temp'
  = matrix __civreghdfe_b = __000002
  - matrix __civreghdfe_V = `V_temp'
  = matrix __civreghdfe_V = __000003
  - local plugin_vars `depvar' `endogvars' `exogvars' `all_instruments' `absorb
> '
  = local plugin_vars y x endog_x  z1 z2 firm
  - if `vce_type' == 2 {
  = if 0 == 2 {
    local plugin_vars `plugin_vars' `cluster_var'
    }
  - if `has_weights' {
  = if 0 {
    local plugin_vars `plugin_vars' `weight_var'
    }
  - plugin call ctools_plugin `plugin_vars' if `touse', "civreghdfe iv_regressi
> on"
  = plugin call ctools_plugin y x endog_x  z1 z2 firm if __000001, "civreghdfe 
> iv_regression"
  - local N_used = __civreghdfe_N
  - local df_r = __civreghdfe_df_r
  - local df_a = __civreghdfe_df_a
  - local K = __civreghdfe_K
  - local rss = __civreghdfe_rss
  - local tss = __civreghdfe_tss
  - local r2 = __civreghdfe_r2
  - local rmse = __civreghdfe_rmse
  - local F_model = __civreghdfe_F
  - forval g = 1/`G' {
  = forval g = 1/1 {
  - capture local fe_levels_`g' = __civreghdfe_num_levels_`g'
  = capture local fe_levels_1 = __civreghdfe_num_levels_1
  - if _rc != 0 local fe_levels_`g' = .
  = if _rc != 0 local fe_levels_1 = .
  - local fe_nested_`g' = 0
  = local fe_nested_1 = 0
  - }
  - if `vce_type' == 2 & "`cluster_var'" != "" {
  = if 0 == 2 & "" != "" {
    forval g = 1/`G' {
    local fevar : word `g' of `absorb'
    if "`fevar'" == "`cluster_var'" {
    local fe_nested_`g' = 1
    }
    else {
    tempvar fe_clust_check
    qui bysort `fevar' (`cluster_var'): gen byte `fe_clust_check' = (`cluster_v
> ar'[1] != `cluster_var'[_N]) if `touse'
    qui summ `fe_clust_check' if `touse', meanonly
    if r(max) == 0 {
    local fe_nested_`g' = 1
    }
    drop `fe_clust_check'
    }
    }
    }
  - if `vce_type' == 2 {
  = if 0 == 2 {
    local N_clust = __civreghdfe_N_clust
    }
  - matrix `b_temp' = __civreghdfe_b
  = matrix __000002 = __civreghdfe_b
  - matrix `V_temp' = __civreghdfe_V
  = matrix __000003 = __civreghdfe_V
  - local varnames_c ""
  - foreach v of local exogvars {
    local varnames_c `varnames_c' `v'
    }
  - foreach v of local endogvars {
  - local varnames_c `varnames_c' `v'
  = local varnames_c  endog_x
  - }
  - local varnames ""
  - foreach v of local endogvars {
  - local varnames `varnames' `v'
  = local varnames  endog_x
  - }
  - foreach v of local exogvars {
    local varnames `varnames' `v'
    }
  - local K_total = `K_exog' + `K_endog'
  = local K_total = 0 + 1
  - if `K_endog' > 0 & `K_exog' > 0 {
  = if 1 > 0 & 0 > 0 {
    tempname b_reorder V_reorder
    matrix `b_reorder' = J(1, `K_total', 0)
    matrix `V_reorder' = J(`K_total', `K_total', 0)
    forvalues e = 1/`K_endog' {
    local c_idx = `K_exog' + `e'
    matrix `b_reorder'[1, `e'] = `b_temp'[1, `c_idx']
    }
    forvalues x = 1/`K_exog' {
    local new_idx = `K_endog' + `x'
    matrix `b_reorder'[1, `new_idx'] = `b_temp'[1, `x']
    }
    forvalues i = 1/`K_total' {
    if `i' <= `K_endog' {
    local old_i = `K_exog' + `i'
    }
    else {
    local old_i = `i' - `K_endog'
    }
    forvalues j = 1/`K_total' {
    if `j' <= `K_endog' {
    local old_j = `K_exog' + `j'
    }
    else {
    local old_j = `j' - `K_endog'
    }
    matrix `V_reorder'[`i', `j'] = `V_temp'[`old_i', `old_j']
    }
    }
    matrix `b_temp' = `b_reorder'
    matrix `V_temp' = `V_reorder'
    }
  - matrix colnames `b_temp' = `varnames'
  = matrix colnames __000002 = endog_x
  - matrix rownames `b_temp' = `depvar'
  = matrix rownames __000002 = y x
conformability error
  ---------------------------------------------------------- end civreghdfe ---
r(503);

end of do-file
r(503);
