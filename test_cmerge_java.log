
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do test_cmerge_java.do 

. * Quick test of cmerge with Java variable creation
. clear all

. set more off

. adopath + build
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "build"

. 
. * Create master dataset
. set obs 1000000
Number of observations (_N) was 0, now 1,000,000.

. gen id = _n

. gen x = runiform()

. tempfile master

. save `master'
file /var/folders/5l/0w9hn2t9637147hqnm7bgk000000gn/T//St88456.000001 saved
    as .dta format

. 
. * Create using dataset
. clear

. set obs 1000000
Number of observations (_N) was 0, now 1,000,000.

. gen id = _n

. gen y = runiform()

. gen z = rnormal()

. tempfile using

. save `using'
file /var/folders/5l/0w9hn2t9637147hqnm7bgk000000gn/T//St88456.000002 saved
    as .dta format

. 
. * Run cmerge
. use `master', clear

. di "Running cmerge m:1..."
Running cmerge m:1...

. cmerge m:1 id using `using', verbose

------------------------------------------------------------
cmerge: Optimized C-Accelerated Merge
------------------------------------------------------------
Merge type:  m:1
Key vars:    id
Using file:  /var/folders/5l/0w9hn2t9637147hqnm7bgk000000gn/T//St88456.000002
Master obs:  1000000
Master vars: 2
------------------------------------------------------------

Phase 1: Loading using dataset (keys + keepusing only)...
  Using: 1000000 obs, keeping 1 keys + 2 keepusing vars

Phase 2: Executing merge with streaming...
build/cmerge.ado

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
        from master                         0  (_merge==1)
        from using                          0  (_merge==2)

    Matched                         1,000,000  (_merge==3)
    -----------------------------------------

cmerge timing breakdown:

  [Phase 1: Load using data into C]
    Load keys:              0.0039 sec
    Load keepusing:         0.0042 sec
    Sort using:             0.0078 sec
    Apply permutation:      0.0016 sec
    --------------------------------
    Phase 1 C total:        0.0175 sec

  [Phase 2: Execute merge]
    Load master keys:       0.0043 sec
    Sort master:            0.0083 sec
    Merge join:             0.0105 sec
    Reorder output:         0.0000 sec
    Write keepusing:        0.0061 sec
    Stream master (2 vars):  0.0084 sec
    Cleanup:                0.0007 sec
    --------------------------------
    Phase 2 C total:        0.0405 sec

  [Outside C code]
    Pre-plugin1 ado:        0.0060 sec  (load using.dta, parse)
    Plugin1 overhead:      -0.0005 sec  (Stata's plugin framework)
    Inter-plugin ado:       0.0680 sec  (breakdown below)
      - restore:            0.0000 sec
      - st_addvar:          0.0630 sec  (create placeholders, _merge)
      - st_store row:       0.0040 sec  (fill _orig_row)
      - set obs:            0.0010 sec  (expand to max output)
    Plugin2 overhead:       0.0005 sec  (Stata's plugin framework)
    Post-plugin ado:        0.0100 sec  (labels, cleanup)
    --------------------------------
    Non-C total:            0.0840 sec

  [Summary]
    Wall clock total:       0.1420 sec
    C code:                   40.9%%
    Plugin overhead:          -0.0%%
    Ado-file overhead:        59.2%%

. 
. * Check results
. di _n "Checking results..."

Checking results...

. assert _N == 1000000

. assert _merge == 3

. sum x y z

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
           x |  1,000,000    .5004142    .2887305   7.23e-08   .9999998
           y |  1,000,000     .500016    .2887179   1.23e-06   .9999977
           z |  1,000,000   -.0013081    .9997509  -5.134265   4.758203

. di "Success!"
Success!

. 
end of do-file
