
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do debug_objective.do 

. * Debug: compute objective values at different solutions
. clear all

. set more off

. adopath + "../build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "../build"

. 
. sysuse auto, clear
(1978 automobile data)

. 
. local q = 0.5  // median

. 
. * Compute objective function rho_q(r) = sum_i |r_i| * (q - I(r_i < 0))
. * For median (q=0.5), this is 0.5 * sum |r_i|
. 
. * Step 1: OLS solution
. quietly regress price mpg

. matrix ols_b = e(b)

. predict double r_ols, resid

. gen double obj_ols_i = abs(r_ols) * (`q' - (r_ols < 0))

. quietly summarize obj_ols_i, meanonly

. local obj_ols = r(sum)

. di "OLS coefficients: mpg=" %12.6f ols_b[1,1] " _cons=" %12.6f ols_b[1,2]
OLS coefficients: mpg= -238.894346 _cons=11253.060658

. di "OLS objective: " %14.4f `obj_ols'
OLS objective:        -0.0000

. drop r_ols obj_ols_i

. 
. * Step 2: qreg solution
. quietly qreg price mpg

. matrix qreg_b = e(b)

. local qreg_adev = e(sum_adev)

. predict double r_qreg, resid

. gen double obj_qreg_i = abs(r_qreg) * (`q' - (r_qreg < 0))

. quietly summarize obj_qreg_i, meanonly

. local obj_qreg = r(sum)

. di _newline "QREG coefficients: mpg=" %12.6f qreg_b[1,1] " _cons=" %12.6f qre
> g_b[1,2]

QREG coefficients: mpg= -135.666667 _cons= 8088.666667

. di "QREG objective (computed): " %14.4f `obj_qreg'
QREG objective (computed):     35739.1667

. di "QREG e(sum_adev):          " %14.4f `qreg_adev'
QREG e(sum_adev):              64760.8333

. drop r_qreg obj_qreg_i

. 
. * Step 3: cqreg solution
. quietly cqreg price mpg

. matrix cqreg_b = e(b)

. local cqreg_adev = e(sum_adev)

. predict double r_cqreg, resid

. gen double obj_cqreg_i = abs(r_cqreg) * (`q' - (r_cqreg < 0))

. quietly summarize obj_cqreg_i, meanonly

. local obj_cqreg = r(sum)

. di _newline "CQREG coefficients: mpg=" %12.6f cqreg_b[1,1] " _cons=" %12.6f c
> qreg_b[1,2]

CQREG coefficients: mpg= -238.867191 _cons=11251.739094

. di "CQREG objective (computed): " %14.4f `obj_cqreg'
CQREG objective (computed):        27.5000

. di "CQREG e(sum_adev):          " %14.4f `cqreg_adev'
CQREG e(sum_adev):              74790.9808

. drop r_cqreg obj_cqreg_i

. 
. di _newline "{hline 60}"

------------------------------------------------------------

. di "SUMMARY"
SUMMARY

. di "{hline 60}"
------------------------------------------------------------

. di "Objective at OLS:   " %14.4f `obj_ols'
Objective at OLS:          -0.0000

. di "Objective at QREG:  " %14.4f `obj_qreg' " (should be lowest)"
Objective at QREG:      35739.1667 (should be lowest)

. di "Objective at CQREG: " %14.4f `obj_cqreg' " (should match qreg)"
Objective at CQREG:        27.5000 (should match qreg)

. di "{hline 60}"
------------------------------------------------------------

. di "Improvement OLS -> QREG: " %10.4f `obj_ols' - `obj_qreg'
Improvement OLS -> QREG: -3.574e+04

. di "Improvement OLS -> CQREG: " %10.4f `obj_ols' - `obj_cqreg'
Improvement OLS -> CQREG:   -27.5000

. di "Gap CQREG - QREG (should be ~0): " %10.4f `obj_cqreg' - `obj_qreg'
Gap CQREG - QREG (should be ~0): -3.571e+04

. 
. * Compute objective manually at qreg coefficients
. di _newline "{hline 60}"

------------------------------------------------------------

. di "VERIFY: Manual objective at qreg coefficients"
VERIFY: Manual objective at qreg coefficients

. di "{hline 60}"
------------------------------------------------------------

. gen double yhat_qreg = qreg_b[1,1] * mpg + qreg_b[1,2]

. gen double r_manual = price - yhat_qreg

. gen double obj_manual_i = abs(r_manual) * (`q' - (r_manual < 0))

. quietly summarize obj_manual_i, meanonly

. di "Manual objective at qreg beta: " %14.4f r(sum)
Manual objective at qreg beta:     35739.1667

. drop yhat_qreg r_manual obj_manual_i

. 
. * Compute objective manually at cqreg coefficients
. di _newline "VERIFY: Manual objective at cqreg coefficients"

VERIFY: Manual objective at cqreg coefficients

. gen double yhat_cqreg = cqreg_b[1,1] * mpg + cqreg_b[1,2]

. gen double r_manual = price - yhat_cqreg

. gen double obj_manual_i = abs(r_manual) * (`q' - (r_manual < 0))

. quietly summarize obj_manual_i, meanonly

. di "Manual objective at cqreg beta: " %14.4f r(sum)
Manual objective at cqreg beta:        27.5000

. drop yhat_cqreg r_manual obj_manual_i

. 
end of do-file
