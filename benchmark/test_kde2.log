
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do test_kde2.do 

. clear all

. set more off

. sysuse auto, clear
(1978 automobile data)

. drop if missing(price, mpg, weight, rep78)
(5 observations deleted)

. 
. qreg price mpg weight, quantile(0.5)

Iteration 1:  WLS sum of weighted deviations =  63341.574

Iteration 1:  Sum of abs. weighted deviations =  63536.156
Iteration 2:  Sum of abs. weighted deviations =  58812.858
Iteration 3:  Sum of abs. weighted deviations =  58491.205
Iteration 4:  Sum of abs. weighted deviations =  58480.736
Iteration 5:  Sum of abs. weighted deviations =  58477.095
Iteration 6:  Sum of abs. weighted deviations =  58466.957

Median regression                                   Number of obs =         69
  Raw sum of deviations    65163 (about 5079)
  Min sum of deviations 58466.96                    Pseudo R2     =     0.1028

------------------------------------------------------------------------------
       price | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         mpg |  -64.08696   121.1752    -0.53   0.599    -306.0211    177.8472
      weight |   .5782609    .896591     0.64   0.521    -1.211841    2.368363
       _cons |       4812   5051.627     0.95   0.344    -5273.898     14897.9
------------------------------------------------------------------------------

. predict double resid, resid

. 
. local N = 69

. local q = 0.5

. 
. * Get qreg implied sparsity
. gen cons = 1

. mkmat mpg weight cons, matrix(X)

. matrix XtX = X' * X

. matrix XtX_inv = syminv(XtX)

. local v11 = e(V)[1,1]

. local implied_s = sqrt(`v11' / (0.25 * XtX_inv[1,1]))

. local implied_f0 = 1/`implied_s'

. 
. display "qreg implied sparsity: " %12.4f `implied_s'
qreg implied sparsity:    6947.1948

. display "qreg implied f(0): " %12.10f `implied_f0'
qreg implied f(0): 0.0001439430

. 
. * Hall-Sheather bandwidth
. local z_alpha = invnormal(0.975)

. local z_q = invnormal(`q')

. local phi_zq = normalden(`z_q')

. local h_prob = `N'^(-1/3) * `z_alpha'^(2/3) * ((1.5 * `phi_zq'^2) / (2*`z_q'^
> 2 + 1))^(1/3)

. 
. * Get residual quantiles
. _pctile resid, percentile(`=(`q'-`h_prob')*100' `=(`q'+`h_prob')*100')

. local r_lo = r(r1)

. local r_hi = r(r2)

. local h_resid = (`r_hi' - `r_lo')

. 
. display _n "h_prob = " %12.8f `h_prob'

h_prob =   0.23687515

. display "h_resid = " %12.4f `h_resid'
h_resid =    2242.3043

. 
. * Compute difference quotient sparsity
. local sparsity_dq = (`r_hi' - `r_lo') / (2 * `h_prob')

. display "DQ sparsity = " %12.4f `sparsity_dq'
DQ sparsity =    4733.0933

. 
. * Standard deviation of residuals
. summ resid

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       resid |         69    945.1418    2578.762  -1875.739   9959.087

. local sd = r(sd)

. display _n "SD of residuals: " %12.4f `sd'

SD of residuals:    2578.7619

. 
. * Silverman optimal bandwidth
. _pctile resid, percentile(25 75)

. local iqr = r(r2) - r(r1)

. local h_silverman = 0.9 * min(`sd', `iqr'/1.349) * `N'^(-0.2)

. display "Silverman bandwidth: " %12.4f `h_silverman'
Silverman bandwidth:     671.6745

. 
. * Use Silverman bandwidth for KDE
. * Epanechnikov kernel: K(u) = 0.75*(1-u^2) for |u|<1
. local sum_kde = 0

. forvalues i = 1/`N' {
  2.     local r = resid[`i']
  3.     local u = `r' / `h_silverman'
  4.     if abs(`u') < 1 {
  5.         local k = 0.75 * (1 - `u'^2)
  6.         local sum_kde = `sum_kde' + `k'
  7.     }
  8. }

. local f0_silverman = `sum_kde' / (`N' * `h_silverman')

. display _n "=== KDE with Silverman bandwidth ==="

=== KDE with Silverman bandwidth ===

. display "f(0) = " %12.10f `f0_silverman'
f(0) = 0.0004645915

. display "sparsity = " %12.4f (1/`f0_silverman')
sparsity =    2152.4287

. 
. * Now try with different bandwidths to find what matches qreg
. display _n "=== SEARCHING FOR MATCHING BANDWIDTH ==="

=== SEARCHING FOR MATCHING BANDWIDTH ===

. display "Target f(0) = " %12.10f `implied_f0'
Target f(0) = 0.0001439430

. 
. foreach h in 500 1000 1500 2000 2500 3000 3500 4000 5000 {
  2.     local sum_kde = 0
  3.     forvalues i = 1/`N' {
  4.         local r = resid[`i']
  5.         local u = `r' / `h'
  6.         if abs(`u') < 1 {
  7.             local k = 0.75 * (1 - `u'^2)
  8.             local sum_kde = `sum_kde' + `k'
  9.         }
 10.     }
 11.     local f0 = `sum_kde' / (`N' * `h')
 12.     local sparsity = 1/`f0'
 13.     display "h=" %5.0f `h' " f(0)=" %12.10f `f0' " sparsity=" %10.2f `spar
> sity' " ratio=" %8.4f (`sparsity'/`implied_s')
 14. }
h=  500 f(0)=0.0004844265 sparsity=   2064.30 ratio=  0.2971
h= 1000 f(0)=0.0004977911 sparsity=   2008.87 ratio=  0.2892
h= 1500 f(0)=0.0003717286 sparsity=   2690.13 ratio=  0.3872
h= 2000 f(0)=0.0003089205 sparsity=   3237.08 ratio=  0.4660
h= 2500 f(0)=0.0002426334 sparsity=   4121.44 ratio=  0.5933
h= 3000 f(0)=0.0002023019 sparsity=   4943.11 ratio=  0.7115
h= 3500 f(0)=0.0001750733 sparsity=   5711.89 ratio=  0.8222
h= 4000 f(0)=0.0001542249 sparsity=   6484.04 ratio=  0.9333
h= 5000 f(0)=0.0001263572 sparsity=   7914.07 ratio=  1.1392

. 
. * Try the h_resid value
. display _n "=== WITH h_resid ==="

=== WITH h_resid ===

. local h = `h_resid'

. local sum_kde = 0

. forvalues i = 1/`N' {
  2.     local r = resid[`i']
  3.     local u = `r' / `h'
  4.     if abs(`u') < 1 {
  5.         local k = 0.75 * (1 - `u'^2)
  6.         local sum_kde = `sum_kde' + `k'
  7.     }
  8. }

. local f0 = `sum_kde' / (`N' * `h')

. display "h_resid=" %8.2f `h_resid' " f(0)=" %12.10f `f0' " sparsity=" %10.2f 
> (1/`f0')
h_resid= 2242.30 f(0)=0.0002725945 sparsity=   3668.45

. 
end of do-file
