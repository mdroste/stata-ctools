
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do benchmark/test_weights.do 

. * Test creghdfe weight support
. * Compare results with reghdfe
. 
. clear all

. set more off

. 
. * Load ctools from build directory
. adopath + "build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "build"

. cap program drop ctools_plugin

. program ctools_plugin, plugin using("build/ctools_mac_arm.plugin")

. 
. * Load test dataset
. sysuse auto, clear
(1978 automobile data)

. 
. * Create weight variable (handle missing rep78)
. gen w = rep78
(5 missing values generated)

. replace w = 3 if missing(w)
(5 real changes made)

. 
. * Display header
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Testing creghdfe weight support"
Testing creghdfe weight support

. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text ""


. 
. * ===========================================================================
> =
. * Test 1: Unweighted baseline (should match exactly)
. * ===========================================================================
> =
. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 1: Unweighted baseline"
Test 1: Unweighted baseline

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. quietly reghdfe price mpg weight, absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_b_weight = _b[weight]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =   21.8536 (se =   74.2211)

. 
. quietly creghdfe price mpg weight, absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_b_weight = _b[weight]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =   21.8536 (se =   74.2211)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: Unweighted coefficients match"
PASS: Unweighted coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. * ===========================================================================
> =
. * Test 2: Analytic weights (aweight)
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 2: Analytic weights [aweight=w]"
Test 2: Analytic weights [aweight=w]

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. quietly reghdfe price mpg weight [aw=w], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =    4.9896 (se =   64.4722)

. 
. quietly creghdfe price mpg weight [aw=w], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =    4.9896 (se =   64.4722)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: aweight coefficients match"
PASS: aweight coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. local se_diff = abs(`reghdfe_se_mpg' - `creghdfe_se_mpg')

. if `se_diff' < 0.0001 {
.     di as result "PASS: aweight standard errors match"
PASS: aweight standard errors match
. }

. else {
.     di as error "FAIL: SE difference = " `se_diff'
. }

. 
. * ===========================================================================
> =
. * Test 3: Frequency weights (fweight)
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 3: Frequency weights [fweight=rep78]"
Test 3: Frequency weights [fweight=rep78]

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. * Note: fweight requires integer values and no missing
. preserve

. drop if missing(rep78)
(5 observations deleted)

. 
. quietly reghdfe price mpg weight [fw=rep78], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =   15.3993 (se =   34.4135)

. 
. quietly creghdfe price mpg weight [fw=rep78], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =   15.3993 (se =   64.8751)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: fweight coefficients match"
PASS: fweight coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. restore

. 
. * ===========================================================================
> =
. * Test 4: Probability weights (pweight) - forces robust
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 4: Probability weights [pweight=w]"
Test 4: Probability weights [pweight=w]

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. quietly reghdfe price mpg weight [pw=w], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =    4.9896 (se =   66.6008)

. 
. quietly creghdfe price mpg weight [pw=w], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =    4.9896 (se =   35.6549)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: pweight coefficients match"
PASS: pweight coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. * ===========================================================================
> =
. * Test 5: Weights with robust VCE
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 5: aweight with robust VCE"
Test 5: aweight with robust VCE

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. quietly reghdfe price mpg weight [aw=w], absorb(foreign) vce(robust)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =    4.9896 (se =   66.6008)

. 
. quietly creghdfe price mpg weight [aw=w], absorb(foreign) vce(robust)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =    4.9896 (se =   35.6549)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: aweight+robust coefficients match"
PASS: aweight+robust coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. * ===========================================================================
> =
. * Test 6: Weights with cluster VCE
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 6: aweight with cluster VCE"
Test 6: aweight with cluster VCE

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. quietly reghdfe price mpg weight [aw=w], absorb(foreign) vce(cluster foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. di as text "reghdfe: mpg = " %9.4f `reghdfe_b_mpg' " (se = " %9.4f `reghdfe_s
> e_mpg' ")"
reghdfe: mpg =    4.9896 (se =  120.2675)

. 
. quietly creghdfe price mpg weight [aw=w], absorb(foreign) vce(cluster foreign
> )

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. di as text "creghdfe: mpg = " %9.4f `creghdfe_b_mpg' " (se = " %9.4f `creghdf
> e_se_mpg' ")"
creghdfe: mpg =    4.9896 (se =   59.7853)

. 
. local diff = abs(`reghdfe_b_mpg' - `creghdfe_b_mpg')

. if `diff' < 0.0001 {
.     di as result "PASS: aweight+cluster coefficients match"
PASS: aweight+cluster coefficients match
. }

. else {
.     di as error "FAIL: Coefficient difference = " `diff'
. }

. 
. * ===========================================================================
> =
. * Test 7: weights=1 should match unweighted
. * ===========================================================================
> =
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test 7: All weights=1 should match unweighted"
Test 7: All weights=1 should match unweighted

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. gen w1 = 1

. 
. quietly creghdfe price mpg weight, absorb(foreign)

. local unweighted_b = _b[mpg]

. 
. quietly creghdfe price mpg weight [aw=w1], absorb(foreign)

. local weighted1_b = _b[mpg]

. 
. local diff = abs(`unweighted_b' - `weighted1_b')

. if `diff' < 0.0001 {
.     di as result "PASS: weights=1 matches unweighted (diff = " %9.6f `diff' "
> )"
PASS: weights=1 matches unweighted (diff =  0.000000)
. }

. else {
.     di as error "FAIL: weights=1 differs from unweighted by " `diff'
. }

. 
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Weight tests complete"
Weight tests complete

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
end of do-file
