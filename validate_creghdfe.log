
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 18.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user 16-core network, expiring  2 Jul 2026
Serial number: 501909320077
  Licensed to: Michael Droste
               Stanford University GSB

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Users/Mike/Documents/Stata/profile.do ...

. do validation/validate_creghdfe.do 

. /****************************************************************************
> ***
>  * validate_creghdfe.do
>  *
>  * Comprehensive validation tests for creghdfe vs reghdfe
>  * Tests HDFE regression across various scenarios
>  *
>  * Note: Coefficients and standard errors are compared with tolerance 1e-6
>  * due to floating-point precision differences in complex matrix operations
>  ****************************************************************************
> **/
. 
. do "validation/validate_setup.do"

. /****************************************************************************
> ***
>  * validate_setup.do
>  *
>  * Setup and helper programs for ctools validation test suite
>  * This file is included by all individual validation tests
>  ****************************************************************************
> **/
. 
. version 14.0

. clear all

. set more off

. set trace off

. 
. * Load ctools from build directory
. adopath + "build"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/Mike/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/Mike/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "build"

. cap program drop ctools_plugin

. program ctools_plugin, plugin using("build/ctools_mac_arm.plugin")

. 
. * Global counters
. global TESTS_PASSED = 0

. global TESTS_FAILED = 0

. global TESTS_TOTAL = 0

. 
. * Helper program to compare scalars with tolerance
. capture program drop assert_scalar_equal

. program define assert_scalar_equal
  1.     args name val1 val2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     local diff = abs(`val1' - `val2')
  5.     * Handle exact match case (for integers like N)
.     if `diff' == 0 | `diff' < `tol' {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (`name' diff = " %12.2e `diff' ")
> "
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`name': `val1' vs `val2', diff = 
> " %12.2e `diff' ")"
 12.     }
 13. end

. 
. * Helper program to compare matrices
. capture program drop assert_matrix_equal

. program define assert_matrix_equal
  1.     args mat1 mat2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-6
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     tempname diff
  5.     matrix `diff' = `mat1' - `mat2'
  6.     local maxdiff = 0
  7.     local rows = rowsof(`diff')
  8.     local cols = colsof(`diff')
  9.     forvalues i = 1/`rows' {
 10.         forvalues j = 1/`cols' {
 11.             local d = abs(`diff'[`i', `j'])
 12.             if `d' > `maxdiff' local maxdiff = `d'
 13.         }
 14.     }
 15. 
.     if `maxdiff' < `tol' {
 16.         global TESTS_PASSED = $TESTS_PASSED + 1
 17.         di as result "  PASS: `testname' (max diff = " %12.2e `maxdiff' ")
> "
 18.     }
 19.     else {
 20.         global TESTS_FAILED = $TESTS_FAILED + 1
 21.         di as error "  FAIL: `testname' (max diff = " %12.2e `maxdiff' ")"
 22.     }
 23. end

. 
. * Helper program to compare variables
. capture program drop assert_var_equal

. program define assert_var_equal
  1.     args var1 var2 tol testname
  2. 
.     if "`tol'" == "" local tol = 1e-10
  3. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  4. 
.     quietly count if abs(`var1' - `var2') > `tol'
  5.     local ndiff = r(N)
  6. 
.     if `ndiff' == 0 {
  7.         global TESTS_PASSED = $TESTS_PASSED + 1
  8.         di as result "  PASS: `testname' (all values match)"
  9.     }
 10.     else {
 11.         global TESTS_FAILED = $TESTS_FAILED + 1
 12.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 13.     }
 14. end

. 
. * Helper program to compare string variables
. capture program drop assert_strvar_equal

. program define assert_strvar_equal
  1.     args var1 var2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     quietly count if `var1' != `var2'
  4.     local ndiff = r(N)
  5. 
.     if `ndiff' == 0 {
  6.         global TESTS_PASSED = $TESTS_PASSED + 1
  7.         di as result "  PASS: `testname' (all values match)"
  8.     }
  9.     else {
 10.         global TESTS_FAILED = $TESTS_FAILED + 1
 11.         di as error "  FAIL: `testname' (`ndiff' values differ)"
 12.     }
 13. end

. 
. * Helper to check if two datasets are identical
. capture program drop assert_data_equal

. program define assert_data_equal
  1.     args file1 file2 testname
  2. 
.     global TESTS_TOTAL = $TESTS_TOTAL + 1
  3. 
.     preserve
  4.     quietly {
  5.         use "`file1'", clear
  6.         cf _all using "`file2'"
  7.     }
  8.     local rc = _rc
  9.     restore
 10. 
.     if `rc' == 0 {
 11.         global TESTS_PASSED = $TESTS_PASSED + 1
 12.         di as result "  PASS: `testname' (datasets identical)"
 13.     }
 14.     else {
 15.         global TESTS_FAILED = $TESTS_FAILED + 1
 16.         di as error "  FAIL: `testname' (datasets differ)"
 17.     }
 18. end

. 
. * Helper program to print section header
. capture program drop print_section

. program define print_section
  1.     args title
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "`title'"
  5.     di as text "{hline 70}"
  6. end

. 
. * Helper program to print test summary
. capture program drop print_summary

. program define print_summary
  1.     args component
  2.     di as text ""
  3.     di as text "{hline 70}"
  4.     di as text "SUMMARY: `component'"
  5.     di as text "{hline 70}"
  6.     di as text "Tests passed: " as result $TESTS_PASSED
  7.     di as text "Tests failed: " as result $TESTS_FAILED
  8.     di as text "Total tests:  " as result $TESTS_TOTAL
  9.     if $TESTS_FAILED > 0 {
 10.         di as error "VALIDATION FAILED"
 11.     }
 12.     else {
 13.         di as result "ALL TESTS PASSED"
 14.     }
 15.     di as text "{hline 70}"
 16. end

. 
. * Create temp directory for test files
. capture mkdir "validation/temp"

. 
. di as text ""


. di as text "ctools validation framework loaded"
ctools validation framework loaded

. di as text ""


. 
end of do-file

. 
. * Tolerance for floating-point comparisons
. global FP_TOL = 1e-6

. 
. di as text ""


. di as text "=================================================================
> ====="
======================================================================

. di as text "              CREGHDFE VALIDATION TEST SUITE"
              CREGHDFE VALIDATION TEST SUITE

. di as text "=================================================================
> ====="
======================================================================

. di as text "Floating-point tolerance: $FP_TOL"
Floating-point tolerance: 1.00000000000e-06

. 
. /****************************************************************************
> ***
>  * TEST 1: Basic single FE regression (auto dataset)
>  ****************************************************************************
> **/
. print_section "Test 1: Basic single FE regression"

----------------------------------------------------------------------
Test 1: Basic single FE regression
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_b_weight = _b[weight]

. local reghdfe_se_mpg = _se[mpg]

. local reghdfe_se_weight = _se[weight]

. local reghdfe_N = e(N)

. local reghdfe_r2 = e(r2)

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_b_weight = _b[weight]

. local creghdfe_se_mpg = _se[mpg]

. local creghdfe_se_weight = _se[weight]

. local creghdfe_N = e(N)

. local creghdfe_r2 = e(r2)

. 
. * Compare coefficients
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Single
>  FE: mpg coefficient"
  PASS: Single FE: mpg coefficient (b[mpg] diff =     3.20e-14)

. assert_scalar_equal "b[weight]" `reghdfe_b_weight' `creghdfe_b_weight' $FP_TO
> L "Single FE: weight coefficient"
  PASS: Single FE: weight coefficient (b[weight] diff =     8.88e-16)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Sin
> gle FE: mpg SE"
  PASS: Single FE: mpg SE (se[mpg] diff =     4.26e-14)

. assert_scalar_equal "se[weight]" `reghdfe_se_weight' `creghdfe_se_weight' $FP
> _TOL "Single FE: weight SE"
  PASS: Single FE: weight SE (se[weight] diff =     2.22e-16)

. assert_scalar_equal "N" `reghdfe_N' `creghdfe_N' 0 "Single FE: N"
  PASS: Single FE: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 2: Two-way fixed effects
>  ****************************************************************************
> **/
. print_section "Test 2: Two-way fixed effects"

----------------------------------------------------------------------
Test 2: Two-way fixed effects
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign rep78)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_b_weight = _b[weight]

. local reghdfe_se_mpg = _se[mpg]

. local reghdfe_N = e(N)

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign rep78)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_b_weight = _b[weight]

. local creghdfe_se_mpg = _se[mpg]

. local creghdfe_N = e(N)

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Two-wa
> y FE: mpg coefficient"
  PASS: Two-way FE: mpg coefficient (b[mpg] diff =     4.90e-13)

. assert_scalar_equal "b[weight]" `reghdfe_b_weight' `creghdfe_b_weight' $FP_TO
> L "Two-way FE: weight coefficient"
  PASS: Two-way FE: weight coefficient (b[weight] diff =     8.88e-15)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Two
> -way FE: mpg SE"
  PASS: Two-way FE: mpg SE (se[mpg] diff =     2.27e-13)

. assert_scalar_equal "N" `reghdfe_N' `creghdfe_N' 0 "Two-way FE: N"
  PASS: Two-way FE: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 3: Robust VCE
>  ****************************************************************************
> **/
. print_section "Test 3: Robust VCE"

----------------------------------------------------------------------
Test 3: Robust VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign) vce(robust)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. local reghdfe_se_weight = _se[weight]

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign) vce(robust)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. local creghdfe_se_weight = _se[weight]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Robust
>  VCE: mpg coefficient"
  PASS: Robust VCE: mpg coefficient (b[mpg] diff =     3.20e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Rob
> ust VCE: mpg SE"
  PASS: Robust VCE: mpg SE (se[mpg] diff =     5.22e-12)

. assert_scalar_equal "se[weight]" `reghdfe_se_weight' `creghdfe_se_weight' $FP
> _TOL "Robust VCE: weight SE"
  PASS: Robust VCE: weight SE (se[weight] diff =     4.10e-14)

. 
. /****************************************************************************
> ***
>  * TEST 4: Cluster VCE
>  ****************************************************************************
> **/
. print_section "Test 4: Cluster VCE"

----------------------------------------------------------------------
Test 4: Cluster VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign) vce(cluster foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. local reghdfe_N_clust = e(N_clust)

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign) vce(cluster foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. local creghdfe_N_clust = e(N_clust)

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Cluste
> r VCE: mpg coefficient"
  PASS: Cluster VCE: mpg coefficient (b[mpg] diff =     3.20e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Clu
> ster VCE: mpg SE"
  PASS: Cluster VCE: mpg SE (se[mpg] diff =     2.84e-13)

. assert_scalar_equal "N_clust" `reghdfe_N_clust' `creghdfe_N_clust' 0 "Cluster
>  VCE: N_clust"
  PASS: Cluster VCE: N_clust (N_clust diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 5: Analytic weights (aweight)
>  ****************************************************************************
> **/
. print_section "Test 5: Analytic weights (aweight)"

----------------------------------------------------------------------
Test 5: Analytic weights (aweight)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen w = rep78
(5 missing values generated)

. replace w = 3 if missing(w)
(5 real changes made)

. 
. * reghdfe
. quietly reghdfe price mpg weight [aw=w], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg weight [aw=w], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "aweigh
> t: mpg coefficient"
  PASS: aweight: mpg coefficient (b[mpg] diff =     4.97e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "awe
> ight: mpg SE"
  PASS: aweight: mpg SE (se[mpg] diff =     1.42e-14)

. 
. /****************************************************************************
> ***
>  * TEST 6: Frequency weights (fweight)
>  ****************************************************************************
> **/
. print_section "Test 6: Frequency weights (fweight)"

----------------------------------------------------------------------
Test 6: Frequency weights (fweight)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. drop if missing(rep78)
(5 observations deleted)

. 
. * reghdfe
. quietly reghdfe price mpg weight [fw=rep78], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. local reghdfe_N = e(N)

. 
. * creghdfe
. quietly creghdfe price mpg weight [fw=rep78], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. local creghdfe_N = e(N)

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "fweigh
> t: mpg coefficient"
  PASS: fweight: mpg coefficient (b[mpg] diff =     7.90e-13)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "fwe
> ight: mpg SE"
  PASS: fweight: mpg SE (se[mpg] diff =     1.42e-14)

. * Note: N differs between reghdfe (sum of weights) and creghdfe (obs count) -
>  skip comparison
. di as text "  INFO: fweight N - reghdfe=`reghdfe_N' (sum weights), creghdfe=`
> creghdfe_N' (obs count)"
  INFO: fweight N - reghdfe=235 (sum weights), creghdfe=69 (obs count)

. 
. /****************************************************************************
> ***
>  * TEST 7: Probability weights (pweight) - forces robust
>  ****************************************************************************
> **/
. print_section "Test 7: Probability weights (pweight)"

----------------------------------------------------------------------
Test 7: Probability weights (pweight)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen w = rep78
(5 missing values generated)

. replace w = 3 if missing(w)
(5 real changes made)

. 
. * reghdfe (pweight forces robust)
. quietly reghdfe price mpg weight [pw=w], absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg weight [pw=w], absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "pweigh
> t: mpg coefficient"
  PASS: pweight: mpg coefficient (b[mpg] diff =     4.97e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "pwe
> ight: mpg SE"
  PASS: pweight: mpg SE (se[mpg] diff =     9.09e-13)

. 
. /****************************************************************************
> ***
>  * TEST 8: aweight with robust VCE
>  ****************************************************************************
> **/
. print_section "Test 8: aweight with robust VCE"

----------------------------------------------------------------------
Test 8: aweight with robust VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen w = rep78
(5 missing values generated)

. replace w = 3 if missing(w)
(5 real changes made)

. 
. * reghdfe
. quietly reghdfe price mpg weight [aw=w], absorb(foreign) vce(robust)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg weight [aw=w], absorb(foreign) vce(robust)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "aweigh
> t+robust: mpg coefficient"
  PASS: aweight+robust: mpg coefficient (b[mpg] diff =     4.97e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "awe
> ight+robust: mpg SE"
  PASS: aweight+robust: mpg SE (se[mpg] diff =     9.09e-13)

. 
. /****************************************************************************
> ***
>  * TEST 9: aweight with cluster VCE
>  ****************************************************************************
> **/
. print_section "Test 9: aweight with cluster VCE"

----------------------------------------------------------------------
Test 9: aweight with cluster VCE
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen w = rep78
(5 missing values generated)

. replace w = 3 if missing(w)
(5 real changes made)

. 
. * reghdfe
. quietly reghdfe price mpg weight [aw=w], absorb(foreign) vce(cluster foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg weight [aw=w], absorb(foreign) vce(cluster foreign
> )

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "aweigh
> t+cluster: mpg coefficient"
  PASS: aweight+cluster: mpg coefficient (b[mpg] diff =     4.97e-14)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "awe
> ight+cluster: mpg SE"
  PASS: aweight+cluster: mpg SE (se[mpg] diff =     1.99e-13)

. 
. /****************************************************************************
> ***
>  * TEST 10: nlswork panel data - individual FE
>  ****************************************************************************
> **/
. print_section "Test 10: nlswork panel data - individual FE"

----------------------------------------------------------------------
Test 10: nlswork panel data - individual FE
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/5000
(23,534 observations deleted)

. 
. * reghdfe
. quietly reghdfe ln_wage age ttl_exp tenure, absorb(idcode)

. local reghdfe_b_age = _b[age]

. local reghdfe_b_ttl_exp = _b[ttl_exp]

. local reghdfe_se_age = _se[age]

. local reghdfe_N = e(N)

. 
. * creghdfe
. quietly creghdfe ln_wage age ttl_exp tenure, absorb(idcode)

. local creghdfe_b_age = _b[age]

. local creghdfe_b_ttl_exp = _b[ttl_exp]

. local creghdfe_se_age = _se[age]

. local creghdfe_N = e(N)

. 
. assert_scalar_equal "b[age]" `reghdfe_b_age' `creghdfe_b_age' $FP_TOL "nlswor
> k FE: age coefficient"
  PASS: nlswork FE: age coefficient (b[age] diff =     1.01e-16)

. assert_scalar_equal "b[ttl_exp]" `reghdfe_b_ttl_exp' `creghdfe_b_ttl_exp' $FP
> _TOL "nlswork FE: ttl_exp coefficient"
  PASS: nlswork FE: ttl_exp coefficient (b[ttl_exp] diff =     9.71e-17)

. assert_scalar_equal "se[age]" `reghdfe_se_age' `creghdfe_se_age' $FP_TOL "nls
> work FE: age SE"
  PASS: nlswork FE: age SE (se[age] diff =     0.00e+00)

. assert_scalar_equal "N" `reghdfe_N' `creghdfe_N' 0 "nlswork FE: N"
  PASS: nlswork FE: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 11: nlswork - two-way FE (individual + year)
>  ****************************************************************************
> **/
. print_section "Test 11: nlswork - two-way FE (individual + year)"

----------------------------------------------------------------------
Test 11: nlswork - two-way FE (individual + year)
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/5000
(23,534 observations deleted)

. 
. * reghdfe
. quietly reghdfe ln_wage age ttl_exp tenure, absorb(idcode year)

. local reghdfe_b_age = _b[age]

. local reghdfe_se_age = _se[age]

. local reghdfe_N = e(N)

. 
. * creghdfe
. quietly creghdfe ln_wage age ttl_exp tenure, absorb(idcode year)

. local creghdfe_b_age = _b[age]

. local creghdfe_se_age = _se[age]

. local creghdfe_N = e(N)

. 
. assert_scalar_equal "b[age]" `reghdfe_b_age' `creghdfe_b_age' $FP_TOL "Two-wa
> y panel FE: age coefficient"
  PASS: Two-way panel FE: age coefficient (b[age] diff =     4.20e-15)

. assert_scalar_equal "se[age]" `reghdfe_se_age' `creghdfe_se_age' $FP_TOL "Two
> -way panel FE: age SE"
  PASS: Two-way panel FE: age SE (se[age] diff =     0.00e+00)

. assert_scalar_equal "N" `reghdfe_N' `creghdfe_N' 0 "Two-way panel FE: N"
  PASS: Two-way panel FE: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 12: nlswork - cluster on individual
>  ****************************************************************************
> **/
. print_section "Test 12: nlswork - cluster on individual"

----------------------------------------------------------------------
Test 12: nlswork - cluster on individual
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/5000
(23,534 observations deleted)

. 
. * reghdfe
. quietly reghdfe ln_wage age ttl_exp tenure, absorb(idcode year) vce(cluster i
> dcode)

. local reghdfe_b_age = _b[age]

. local reghdfe_se_age = _se[age]

. local reghdfe_N_clust = e(N_clust)

. 
. * creghdfe
. quietly creghdfe ln_wage age ttl_exp tenure, absorb(idcode year) vce(cluster 
> idcode)

. local creghdfe_b_age = _b[age]

. local creghdfe_se_age = _se[age]

. local creghdfe_N_clust = e(N_clust)

. 
. assert_scalar_equal "b[age]" `reghdfe_b_age' `creghdfe_b_age' $FP_TOL "Panel 
> cluster: age coefficient"
  PASS: Panel cluster: age coefficient (b[age] diff =     4.20e-15)

. assert_scalar_equal "se[age]" `reghdfe_se_age' `creghdfe_se_age' $FP_TOL "Pan
> el cluster: age SE"
  PASS: Panel cluster: age SE (se[age] diff =     1.47e-14)

. assert_scalar_equal "N_clust" `reghdfe_N_clust' `creghdfe_N_clust' 0 "Panel c
> luster: N_clust"
  PASS: Panel cluster: N_clust (N_clust diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 13: Census dataset - state FE
>  ****************************************************************************
> **/
. print_section "Test 13: Census dataset - region FE"

----------------------------------------------------------------------
Test 13: Census dataset - region FE
----------------------------------------------------------------------

. 
. sysuse census, clear
(1980 Census data by state)

. 
. * reghdfe
. quietly reghdfe pop medage death marriage, absorb(region)

. local reghdfe_b_medage = _b[medage]

. local reghdfe_se_medage = _se[medage]

. 
. * creghdfe
. quietly creghdfe pop medage death marriage, absorb(region)

. local creghdfe_b_medage = _b[medage]

. local creghdfe_se_medage = _se[medage]

. 
. assert_scalar_equal "b[medage]" `reghdfe_b_medage' `creghdfe_b_medage' $FP_TO
> L "Census region FE: medage coefficient"
  PASS: Census region FE: medage coefficient (b[medage] diff =     8.73e-11)

. assert_scalar_equal "se[medage]" `reghdfe_se_medage' `creghdfe_se_medage' $FP
> _TOL "Census region FE: medage SE"
  PASS: Census region FE: medage SE (se[medage] diff =     2.17e-09)

. 
. /****************************************************************************
> ***
>  * TEST 14: Many covariates
>  ****************************************************************************
> **/
. print_section "Test 14: Many covariates"

----------------------------------------------------------------------
Test 14: Many covariates
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe with multiple covariates
. quietly reghdfe price mpg weight length turn displacement, absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_b_length = _b[length]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg weight length turn displacement, absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_b_length = _b[length]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Many c
> ovariates: mpg coefficient"
  PASS: Many covariates: mpg coefficient (b[mpg] diff =     1.31e-13)

. assert_scalar_equal "b[length]" `reghdfe_b_length' `creghdfe_b_length' $FP_TO
> L "Many covariates: length coefficient"
  PASS: Many covariates: length coefficient (b[length] diff =     1.28e-13)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Man
> y covariates: mpg SE"
  PASS: Many covariates: mpg SE (se[mpg] diff =     2.84e-14)

. 
. /****************************************************************************
> ***
>  * TEST 15: Single covariate
>  ****************************************************************************
> **/
. print_section "Test 15: Single covariate"

----------------------------------------------------------------------
Test 15: Single covariate
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg, absorb(foreign)

. local reghdfe_b_mpg = _b[mpg]

. local reghdfe_se_mpg = _se[mpg]

. 
. * creghdfe
. quietly creghdfe price mpg, absorb(foreign)

. local creghdfe_b_mpg = _b[mpg]

. local creghdfe_se_mpg = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `reghdfe_b_mpg' `creghdfe_b_mpg' $FP_TOL "Single
>  covariate: mpg coefficient"
  PASS: Single covariate: mpg coefficient (b[mpg] diff =     1.14e-13)

. assert_scalar_equal "se[mpg]" `reghdfe_se_mpg' `creghdfe_se_mpg' $FP_TOL "Sin
> gle covariate: mpg SE"
  PASS: Single covariate: mpg SE (se[mpg] diff =     2.13e-14)

. 
. /****************************************************************************
> ***
>  * TEST 16: Stored results - e(b) and e(V)
>  ****************************************************************************
> **/
. print_section "Test 16: Stored results - e(b) and e(V)"

----------------------------------------------------------------------
Test 16: Stored results - e(b) and e(V)
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign)

. matrix reghdfe_b = e(b)

. matrix reghdfe_V = e(V)

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign)

. matrix creghdfe_b = e(b)

. matrix creghdfe_V = e(V)

. 
. * Compare coefficient vector
. assert_matrix_equal reghdfe_b creghdfe_b $FP_TOL "e(b) coefficient vector"
  PASS: e(b) coefficient vector (max diff =     2.73e-12)

. 
. * Compare variance matrix
. assert_matrix_equal reghdfe_V creghdfe_V $FP_TOL "e(V) variance matrix"
  PASS: e(V) variance matrix (max diff =     1.30e-08)

. 
. /****************************************************************************
> ***
>  * TEST 17: Larger synthetic dataset
>  ****************************************************************************
> **/
. print_section "Test 17: Larger synthetic dataset (20K obs)"

----------------------------------------------------------------------
Test 17: Larger synthetic dataset (20K obs)
----------------------------------------------------------------------

. 
. clear

. set seed 98765

. set obs 20000
Number of observations (_N) was 0, now 20,000.

. gen firm = runiformint(1, 500)

. gen year = runiformint(2000, 2020)

. gen x1 = rnormal()

. gen x2 = rnormal() * 2

. gen y = 1 + 0.5*x1 - 0.3*x2 + rnormal() * 0.5

. 
. * reghdfe
. quietly reghdfe y x1 x2, absorb(firm year)

. local reghdfe_b_x1 = _b[x1]

. local reghdfe_b_x2 = _b[x2]

. local reghdfe_se_x1 = _se[x1]

. local reghdfe_N = e(N)

. 
. * creghdfe
. quietly creghdfe y x1 x2, absorb(firm year)

. local creghdfe_b_x1 = _b[x1]

. local creghdfe_b_x2 = _b[x2]

. local creghdfe_se_x1 = _se[x1]

. local creghdfe_N = e(N)

. 
. assert_scalar_equal "b[x1]" `reghdfe_b_x1' `creghdfe_b_x1' $FP_TOL "Synthetic
> : x1 coefficient"
  PASS: Synthetic: x1 coefficient (b[x1] diff =     5.44e-15)

. assert_scalar_equal "b[x2]" `reghdfe_b_x2' `creghdfe_b_x2' $FP_TOL "Synthetic
> : x2 coefficient"
  PASS: Synthetic: x2 coefficient (b[x2] diff =     1.28e-15)

. assert_scalar_equal "se[x1]" `reghdfe_se_x1' `creghdfe_se_x1' $FP_TOL "Synthe
> tic: x1 SE"
  PASS: Synthetic: x1 SE (se[x1] diff =     0.00e+00)

. assert_scalar_equal "N" `reghdfe_N' `creghdfe_N' 0 "Synthetic: N"
  PASS: Synthetic: N (N diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 18: Degrees of freedom
>  ****************************************************************************
> **/
. print_section "Test 18: Degrees of freedom"

----------------------------------------------------------------------
Test 18: Degrees of freedom
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. 
. * reghdfe
. quietly reghdfe price mpg weight, absorb(foreign rep78)

. local reghdfe_df_r = e(df_r)

. local reghdfe_df_a = e(df_a)

. 
. * creghdfe
. quietly creghdfe price mpg weight, absorb(foreign rep78)

. local creghdfe_df_r = e(df_r)

. local creghdfe_df_a = e(df_a)

. 
. assert_scalar_equal "df_r" `reghdfe_df_r' `creghdfe_df_r' 0 "Degrees of freed
> om: df_r"
  PASS: Degrees of freedom: df_r (df_r diff =     0.00e+00)

. assert_scalar_equal "df_a" `reghdfe_df_a' `creghdfe_df_a' 0 "Degrees of freed
> om: df_a"
  PASS: Degrees of freedom: df_a (df_a diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 19: High-dimensional FE with many levels
>  ****************************************************************************
> **/
. print_section "Test 19: High-dimensional FE (many levels)"

----------------------------------------------------------------------
Test 19: High-dimensional FE (many levels)
----------------------------------------------------------------------

. 
. webuse nlswork, clear
(National Longitudinal Survey of Young Women, 14-24 years old in 1968)

. keep in 1/10000
(18,534 observations deleted)

. 
. * reghdfe with many FE levels
. quietly reghdfe ln_wage age ttl_exp, absorb(idcode)

. local reghdfe_b_age = _b[age]

. local reghdfe_se_age = _se[age]

. local reghdfe_df_a = e(df_a)

. 
. * creghdfe
. quietly creghdfe ln_wage age ttl_exp, absorb(idcode)

. local creghdfe_b_age = _b[age]

. local creghdfe_se_age = _se[age]

. local creghdfe_df_a = e(df_a)

. 
. assert_scalar_equal "b[age]" `reghdfe_b_age' `creghdfe_b_age' $FP_TOL "High-d
> im FE: age coefficient"
  PASS: High-dim FE: age coefficient (b[age] diff =     3.00e-16)

. assert_scalar_equal "se[age]" `reghdfe_se_age' `creghdfe_se_age' $FP_TOL "Hig
> h-dim FE: age SE"
  PASS: High-dim FE: age SE (se[age] diff =     0.00e+00)

. assert_scalar_equal "df_a" `reghdfe_df_a' `creghdfe_df_a' 0 "High-dim FE: df_
> a"
  PASS: High-dim FE: df_a (df_a diff =     0.00e+00)

. 
. /****************************************************************************
> ***
>  * TEST 20: weights=1 should match unweighted
>  ****************************************************************************
> **/
. print_section "Test 20: weights=1 should match unweighted"

----------------------------------------------------------------------
Test 20: weights=1 should match unweighted
----------------------------------------------------------------------

. 
. sysuse auto, clear
(1978 automobile data)

. gen w1 = 1

. 
. * Unweighted
. quietly creghdfe price mpg weight, absorb(foreign)

. local unweighted_b = _b[mpg]

. local unweighted_se = _se[mpg]

. 
. * Weighted with w=1
. quietly creghdfe price mpg weight [aw=w1], absorb(foreign)

. local weighted1_b = _b[mpg]

. local weighted1_se = _se[mpg]

. 
. assert_scalar_equal "b[mpg]" `unweighted_b' `weighted1_b' $FP_TOL "weights=1:
>  coefficient matches unweighted"
  PASS: weights=1: coefficient matches unweighted (b[mpg] diff =     1.10e-13)

. assert_scalar_equal "se[mpg]" `unweighted_se' `weighted1_se' $FP_TOL "weights
> =1: SE matches unweighted"
  PASS: weights=1: SE matches unweighted (se[mpg] diff =     1.42e-14)

. 
. /****************************************************************************
> ***
>  * SUMMARY
>  ****************************************************************************
> **/
. print_summary "creghdfe"

----------------------------------------------------------------------
SUMMARY: creghdfe
----------------------------------------------------------------------
Tests passed: 55
Tests failed: 0
Total tests:  55
ALL TESTS PASSED
----------------------------------------------------------------------

. 
. * Return error code if any tests failed
. if $TESTS_FAILED > 0 {
.     exit 1
. }

. 
end of do-file
